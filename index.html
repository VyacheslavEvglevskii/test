<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞-—Ç–µ–≥–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon-192.svg" type="image/svg+xml">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PackControl">
<link rel="apple-touch-icon" href="icon-512.svg">
  <title>üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</title>
  <style>
  /* ===== –û—Å–Ω–æ–≤—ã ===== */

/* –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑—É–º–∞ */
* {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

/* –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
input, textarea, select {
  -webkit-user-select: text;
  -khtml-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

body {
  margin: 0;
  padding: 72px 12px 12px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: #f1f5f9;
  /* –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  overscroll-behavior: none;
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è */
  overflow-x: hidden;
  position: relative;
  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –∑—É–º–∞ */
  zoom: 1;
  -ms-zoom: 1;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

/* === –ú–û–ë–ò–õ–¨–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò === */

/* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π (iPhone X+) */
@supports (padding: max(0px)) {
  body {
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
    padding-bottom: max(12px, env(safe-area-inset-bottom));
  }
  
  .top-nav {
    padding-top: max(10px, env(safe-area-inset-top));
    padding-left: max(0px, env(safe-area-inset-left));
    padding-right: max(0px, env(safe-area-inset-right));
  }
}

/* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
@media (max-width: 480px) {
  body {
    padding: 60px 8px 8px;
    font-size: 14px;
  }
  
  .container {
    margin: 12px auto;
    padding: 16px;
    border-radius: 12px;
  }
  
  h2 {
    font-size: 20px;
    margin-bottom: 16px;
  }
  
  /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Å–∞–Ω–∏—è */
  button {
    min-height: 44px;
    padding: 16px 20px;
    font-size: 16px;
    margin-top: 16px;
  }
  
  input, select, textarea {
    min-height: 44px;
    padding: 14px 16px;
    font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
    margin-bottom: 12px;
  }
  
  label {
    margin-top: 12px;
    margin-bottom: 8px;
    font-size: 16px;
  }
}

/* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —ç–∫—Ä–∞–Ω—ã */
@media (max-width: 360px) {
  .container {
    margin: 8px auto;
    padding: 12px;
  }
  
  .form-row {
    flex-direction: column;
  }
  
  .form-item {
    flex: 1 1 100%;
  }
}

/* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-height: 500px) and (orientation: landscape) {
  body {
    padding: 50px 12px 12px;
  }
  
  .container {
    margin: 8px auto;
    padding: 12px;
  }
  
  h2 {
    font-size: 18px;
    margin-bottom: 12px;
  }
  
  .top-nav {
    padding: 6px 0;
  }
  
  .top-nav button {
    padding: 8px 4px;
    font-size: 20px;
  }
}

.table-scroll {
  overflow-x: auto;
  width: 100%;
  /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
}

.table-scroll::-webkit-scrollbar {
  height: 6px;
}

.table-scroll::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.table-scroll::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 3px;
}

.table-scroll::-webkit-scrollbar-thumb:hover {
  background: #555;
}

@media (max-width: 600px) {
  #ratesTable table, .table-scroll table {
    font-size: 12px;
    min-width: 600px;
  }
  #ratesTable th, #ratesTable td {
    padding: 6px 8px;
  }
  
  /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü */
  .table-scroll {
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  
  .table-scroll table {
    border-collapse: separate;
    border-spacing: 0;
  }
  
  .table-scroll th:first-child {
    border-top-left-radius: 8px;
  }
  
  .table-scroll th:last-child {
    border-top-right-radius: 8px;
  }
  
  /* –°–∂–∏–º–∞–µ–º –∫–æ–ª–æ–Ω–∫—É —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  .table-scroll th:nth-child(3),
  .table-scroll td:nth-child(3) {
    width: 60px;
    max-width: 60px;
    font-size: 11px;
    text-align: center;
  }
  
  /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏ –Ω–æ—Ä–º */
  .table-scroll th:nth-child(4),
  .table-scroll td:nth-child(4) {
    font-size: 10px;
    max-width: 120px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
}

/* –°–≤–∞–π–ø –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 600px) {
  .table-scroll::after {
    content: "üëà –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏";
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #6b7280;
    background: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 4px;
    pointer-events: none;
    opacity: 0;
    animation: swipeHint 3s ease-in-out;
  }
  
  @keyframes swipeHint {
    0%, 100% { opacity: 0; }
    20%, 80% { opacity: 1; }
  }
  
  .table-scroll {
    position: relative;
  }
}

h2 {
  font-size: 22px;
  font-weight: 600;
  color: #0f172a;
  margin-bottom: 20px;
  text-align: center;
}

.container {
  background-color: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin: 24px auto;
  max-width: 600px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤–∫–ª–∞–¥–æ–∫ */
#profileContainer,
#appContainer, 
#statsContainer,
#adminContainer,
#mySalaryContainer,
#ratesContainer {
  will-change: opacity, transform;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

label {
  display: block;
  font-weight: 600;
  color: #374151;
  margin-top: 16px;
  margin-bottom: 6px;
  font-size: 15px;
}

input, select, textarea {
  width: 100%;
  padding: 12px;
  font-size: 16px; /* 16px –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
  border: 1px solid #d1d5db;
  border-radius: 10px;
  background: #f9fafb;
  color: #111827;
  margin-bottom: 16px;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

input:focus, select:focus, textarea:focus {
  border-color: #2563eb;
  background-color: #ffffff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
}

/* ===== –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ===== */
@keyframes ripple {
  0% {
    transform: scale(0);
    opacity: 1;
  }
  100% {
    transform: scale(4);
    opacity: 0;
  }
}

@keyframes buttonPulse {
  0%, 100% {
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
  }
  50% {
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200px 0;
  }
  100% {
    background-position: calc(200px + 100%) 0;
  }
}

button {
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  padding: 14px 18px;
  font-size: 15px;
  font-weight: 600;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  transition: left 0.5s;
}

button:hover::before {
  left: 100%;
}

button:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
  animation: buttonPulse 2s infinite;
}

button:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 2px 10px rgba(37, 99, 235, 0.3);
  transition: all 0.1s ease;
}

button:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
}

/* –≠—Ñ—Ñ–µ–∫—Ç ripple –ø—Ä–∏ –∫–ª–∏–∫–µ */
button.ripple {
  position: relative;
  overflow: hidden;
}

button.ripple::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.6);
  transform: scale(0);
  animation: ripple 0.6s linear;
  pointer-events: none;
}

button.danger {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
}

button.danger:hover {
  background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
  box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
  animation: buttonPulse 2s infinite;
}

button.danger:hover::before {
  left: 100%;
}

/* –ö–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
button.loading {
  pointer-events: none;
  position: relative;
  color: transparent;
}

button.loading::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid #ffffff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* –£—Å–ø–µ—à–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
button.success {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2);
}

button.success:hover {
  background: linear-gradient(135deg, #047857 0%, #065f46 100%);
  box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
}

.top-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background-color: #2563eb;
  padding: 10px 0;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.top-nav button {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  flex: 1;
  text-align: center;
  padding: 12px 8px;
  border-radius: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  margin: 4px;
  text-transform: none;
  letter-spacing: normal;
  box-shadow: none;
}

.top-nav button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.1),
    transparent
  );
  transition: left 0.4s;
}

.top-nav button:hover::before {
  left: 100%;
}

.top-nav button:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.top-nav button:active {
  transform: scale(0.95) translateY(0);
  background: rgba(255, 255, 255, 0.2);
}

.top-nav button.active {
  background: linear-gradient(135deg, #1e40af, #1d4ed8);
  color: white;
  box-shadow: 0 4px 15px rgba(30, 64, 175, 0.4);
  transform: translateY(-1px);
}

.top-nav button.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 3px;
  background: linear-gradient(90deg, #60a5fa, #3b82f6);
  border-radius: 2px;
  animation: navGlow 2s ease-in-out infinite alternate;
}

@keyframes navGlow {
  0% {
    box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
  }
  100% {
    box-shadow: 0 0 20px rgba(96, 165, 250, 0.8);
  }
}

/* === –ú–û–ë–ò–õ–¨–ù–´–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò === */

/* Haptic feedback —ç–º—É–ª—è—Ü–∏—è */
@keyframes vibrate {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-1px); }
  20%, 40%, 60%, 80% { transform: translateX(1px); }
}

.haptic-feedback {
  animation: vibrate 0.2s ease-in-out;
}

/* Pull-to-refresh –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
.pull-to-refresh {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  background: rgba(37, 99, 235, 0.9);
  color: white;
  padding: 8px 16px;
  border-radius: 0 0 12px 12px;
  font-size: 14px;
  font-weight: 600;
  z-index: 1001;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.pull-to-refresh.active {
  transform: translateX(-50%) translateY(0);
}

/* –°–≤–∞–π–ø –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
.swipe-indicator {
  position: fixed;
  top: 50%;
  font-size: 24px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 12px;
  border-radius: 50%;
  z-index: 1002;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.swipe-indicator.left {
  left: 10px;
  transform: translateY(-50%);
}

.swipe-indicator.right {
  right: 10px;
  transform: translateY(-50%);
}

.swipe-indicator.show {
  opacity: 1;
}

/* –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
@media (max-width: 600px) {
  .top-nav {
    padding: 8px 0;
    height: 60px;
    display: flex;
    align-items: center;
  }
  
  .top-nav button {
    font-size: 22px;
    padding: 10px 4px;
    min-height: 44px;
    min-width: 44px;
    margin: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  .top-nav button.active {
    background: linear-gradient(135deg, #1e40af, #1d4ed8);
    transform: scale(1.05) translateY(-1px);
    box-shadow: 0 6px 20px rgba(30, 64, 175, 0.5);
  }
  
  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ */
  .top-nav button {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .top-nav button:active {
    transform: scale(0.9);
    background: rgba(255, 255, 255, 0.3);
  }
}

/* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è iPhone X+ */
@supports (padding: max(0px)) and (max-width: 600px) {
  .top-nav {
    padding-top: max(8px, env(safe-area-inset-top));
  }
}

/* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
@media (max-width: 900px) and (orientation: landscape) {
  .top-nav {
    padding: 6px 0;
    height: 50px;
  }
  
  .top-nav button {
    font-size: 20px;
    padding: 8px 6px;
    min-height: 40px;
  }
}

.stat-card {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  padding: 16px;
  margin-top: 16px;
  font-size: 15px;
  color: #1f2937;
}

.stat-card p {
  margin: 6px 0;
}

.stat-card button {
  margin-top: 12px;
  padding: 8px 16px;
  font-size: 14px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
  text-transform: none;
  letter-spacing: normal;
  width: auto;
  min-width: 100px;
}

.stat-card button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  transition: left 0.4s;
}

.stat-card button:hover::before {
  left: 100%;
}

.stat-card button:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.stat-card button:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
}

#rateInfo, #calcBlock {
  margin-top: 16px;
  padding: 16px;
  border-radius: 12px;
  background-color: #f3f4f6;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
  font-size: 15px;
  color: #1f2937;
}

#rateInfo p, #calcBlock p {
  margin: 8px 0;
  display: flex;
  justify-content: space-between;
  font-weight: 500;
}

#rateInfo strong, #calcBlock strong {
  color: #111827;
}

#totalWage {
  font-size: 16px;
  margin-top: 16px;
  background: #ecfdf5;
  padding: 12px;
  border-radius: 10px;
  text-align: center;
  color: #065f46;
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
}

#editModal {
  max-width: 480px;
  background-color: white;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  padding: 24px;
  font-size: 15px;
  color: #1f2937;
}

#editModal label {
  display: block;
  margin-top: 12px;
  font-weight: 500;
}

#editModal select, #editModal input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-size: 15px;
}

#editModal button {
  margin-top: 16px;
  padding: 12px 20px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
  text-transform: none;
  letter-spacing: normal;
  width: auto;
  min-width: 120px;
}

#editModal button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255, 255, 255, 0.2),
    transparent
  );
  transition: left 0.4s;
}

#editModal button:hover::before {
  left: 100%;
}

#editModal button:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
}

#editModal button:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
}

#editModal button.danger {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
  margin-left: 12px;
}

#editModal button.danger:hover {
  background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
  box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);
}

.tooltip[data-tooltip]:hover::after {
  content: attr(data-tooltip);
  position: absolute;
  background-color: #1f2937;
  color: white;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: nowrap;
  top: 100%;
  left: 0;
  margin-top: 6px;
  z-index: 10;
}

#ratesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

#ratesTable th, #ratesTable td {
  padding: 12px 14px;
  text-align: left;
  font-size: 14px;
}

#ratesTable th {
  background-color: #f3f4f6;
  color: #374151;
  font-weight: 600;
}

#ratesTable tr:nth-child(even) td {
  background-color: #f9fafb;
}

#ratesTable tr:hover td {
  background-color: #eef2ff;
}

#adminContainer {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-top: 20px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

#adminContainer h3 {
  font-size: 18px;
  margin-bottom: 12px;
  color: #1f2937;
  font-weight: 600;
}

#adminContainer input[type="text"],
#adminContainer select {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 15px;
  background: #f9fafb;
}

#adminContainer button {
  margin-top: 12px;
}

@media (max-width: 500px) {
  .container, #editModal {
    padding: 16px;
    border-radius: 12px;
  }

  #ratesTable th, #ratesTable td {
    padding: 10px 12px;
  }

  button {
    font-size: 14px;
    padding: 12px;
  }

  h2 {
    font-size: 20px;
  }

  #adminContainer label {
    flex: 1 1 100%;
  }

  #adminContainer input[type="date"] {
    font-size: 16px;
  }

  .form-item label,
  input,
  select {
    font-size: 14px;
    padding: 6px;
  }
}

#appContainer.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

#saveBar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  padding: 12px;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.08);
  z-index: 1100;
}

#saveBar button {
  width: 100%;
  font-size: 16px;
}

.form-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.form-item {
  flex: 1 1 200px;
  min-width: 140px;
}

.form-item label {
  display: block;
  font-size: 16px;
  margin-bottom: 6px;
}

@media (max-width: 600px) {
  body {
    padding: 48px 2px 2px;
    font-size: 15px;
  }
  .container, .block, #editModal, #adminContainer, #mySalaryContainer, #ratesContainer, #profileContainer {
    padding: 6px 2px;
    border-radius: 8px;
    max-width: 100vw;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    margin: 6px 0;
  }
  h2, .block-title {
    font-size: 17px;
    margin-bottom: 10px;
  }
  label, .item-label {
    font-size: 13px;
    margin-bottom: 2px;
  }
  input, select, textarea {
    font-size: 14px;
    min-height: 38px;
    padding: 6px 4px;
    border-radius: 7px;
  }
  button, .button {
    font-size: 14px;
    min-height: 38px;
    border-radius: 8px;
    padding: 8px 0;
  }
  .form-row, .block, .list {
    margin-bottom: 6px;
  }
  .table-scroll {
    overflow-x: auto;
    max-width: 100vw;
  }
  table {
    min-width: 480px;
    font-size: 12px;
  }
  th, td {
    white-space: nowrap;
    padding: 5px 6px;
  }
}

  </style>
</head>
<body>
<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —ç–∫—Ä–∞–Ω -->
<div id="loadingScreen" style="
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  color: white;
">
  <div style="
    font-size: 64px;
    margin-bottom: 20px;
    animation: pulse 2s infinite;
  ">üì¶</div>
  <h1 style="
    font-size: 28px;
    margin: 0 0 10px 0;
    font-weight: 600;
    text-align: center;
  ">–£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</h1>
  <p style="
    font-size: 16px;
    margin: 0;
    opacity: 0.8;
    text-align: center;
  ">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
  <div style="
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top: 3px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-top: 30px;
  "></div>
</div>
  <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã -->
  <div class="pull-to-refresh" id="pullToRefresh">
    ‚Üì –ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  </div>
  
  <div class="swipe-indicator left" id="swipeLeft">
    ‚Üê
  </div>
  
  <div class="swipe-indicator right" id="swipeRight">
    ‚Üí
  </div>
  
  <nav id="bottomNav" class="top-nav" style="display: none;">
    <button id="tabProfile" onclick="switchTab('profile')">üë§</button>
    <button id="tabApp" onclick="switchTab('app')" disabled>üìã</button>
    <button id="tabStats" onclick="switchTab('stats')">üìà</button>
    <button id="tabRates" onclick="switchTab('rates')">üí∞</button>
    <button id="tabMySalary" onclick="switchTab('mySalary')">üíµ</button>
    <button id="tabAdmin" onclick="switchTab('admin')" style="display: none;">üõ†Ô∏è</button>
  </nav>
<div class="container" id="loginContainer">
  <h2>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
  <label for="login">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
  <input type="text" id="login" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>

  <label for="password">–ü–∞—Ä–æ–ª—å</label>
  <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>

  <button onclick="handleLogin()" class="login-btn pulse">üîê –í–æ–π—Ç–∏</button>
  <div id="loginError"></div>
</div>
<div class="container" style="display:none;" id="tabContainer">
</div>
<div class="container" style="display:none;" id="appContainer">
  <style>
    .form-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .form-item {
      flex: 1 1 200px;
    }
    /* –£–¥–∞–ª–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ column –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
  </style>

  <h2 id="mainTitle">üì¶ –£—á—ë—Ç —É–ø–∞–∫–æ–≤–∫–∏</h2>
  <form id="dataForm" style="padding-bottom: 100px;">
    <div class="tooltip" data-tooltip="–ü–æ–ª–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ">
      <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
        <input name="employeeName" required readonly />
      </label>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
          <input name="quantity" type="number" required />
        </label>
      </div>
      <div class="form-item">
        <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:
          <input name="orderNumber" required />
        </label>
      </div>
    </div>

    <div class="form-row">
      <div class="form-item">
        <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:
          <input name="startTime" type="time" required />
        </label>
      </div>
      <div class="form-item">
        <label>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:
          <input name="endTime" type="time" required />
        </label>
      </div>
    </div>

    <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
      <input name="duration" readonly />
    </label>

    <div class="form-row" id="operationSetWrapper">
  <div class="form-item">
    <label>–û–ø–µ—Ä–∞—Ü–∏—è:
      <select name="operationType" id="operationSelect" required></select>
    </label>
  </div>
  <div class="form-item" id="setNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber"></select>
    </label>
  </div>
</div>

<div id="volumeLabel">
  <label>–û–±—ä—ë–º:
    <select name="volume" id="volumeSelect" required></select>
  </label>
</div>

    <div id="rateInfo" style="margin-top:16px; background:#f0f0f0; padding:10px; border-radius:8px; display:none;">
      <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> <span id="normDisplay">-</span></p>
      <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ 1 —à—Ç:</strong> <span id="rateDisplay">-</span></p>
    </div>

    <div id="calcBlock" style="margin-top:16px; background:#e7f5ff; padding:10px; border-radius:8px; display:none;">
      <p><strong>üí∏ –†–∞—Å—á—ë—Ç –æ–ø–ª–∞—Ç—ã:</strong> <span id="wageDisplay">-</span></p>
      <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> <span id="efficiencyDisplay">-</span></p>
    </div>

    <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>
  <p id="result" style="display:none;"></p>
</div>
<div class="container" style="display:none;" id="statsContainer">
  <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<button onclick="closeStats()" style="margin-bottom: 10px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
  <label>–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É:<input type="date" id="statsDate"></label>
  <div style="margin-top: 12px;">
  <label>–§–∏–ª—å—Ç—Ä –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏:
    <select id="operationFilter">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
  </label>
  <button id="showStatsBtn" onclick="loadStats()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>
  <div id="statsCards"></div>
<div id="statsLogs" style="margin-top: 16px;"></div>
<p id="totalWage" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<div class="container" style="display:none;" id="profileContainer">
  <h2>üë§ –õ–∏—á–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
  <label>–¢–∏–ø —Å–º–µ–Ω—ã:
    <select id="shiftType">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–º–µ–Ω—É --</option>
      <option>–î–µ–Ω—å</option>
      <option>–ù–æ—á—å</option>
    </select>
  </label>

  <label>–°—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
    <select id="employeeStatus">
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å --</option>
      <option>–®—Ç–∞—Ç</option>
      <option>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥</option>
      <option>–°—Ç–∞–∂—ë—Ä</option>
    </select>
  </label>
<label>–¢–∏–ø –æ–ø–ª–∞—Ç—ã:
  <select id="profilePayType" required>
    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
    <option value="–°–¥–µ–ª–∫–∞">–°–¥–µ–ª–∫–∞</option>
    <option value="–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞">–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞</option>
  </select>
</label>
<div id="salaryBlock" style="display:none;">
  <label>–û–∫–ª–∞–¥:
    <input id="profileSalary" type="number" readonly />
  </label>
</div>
  <!-- –í–°–¢–ê–í–¨ –°–Æ–î–ê: -->
  <label>–ú–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏:
    <select id="profilePackingModel" name="profilePackingModel" required>
      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
      <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ -->
    </select>
  </label>

  <button onclick="saveProfile()" class="save-btn floating-button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <p id="profileSaved" style="color:green; text-align:center; display:none;">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</p>
  <p id="profileHint" style="color:#dc2626; font-size:14px; text-align:center; margin-top:12px;">
  ‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∫–ª–∞–¥–∫–∞–º —Å–∏—Å—Ç–µ–º—ã.
</p>
  <button id="logoutBtn" onclick="handleLogout()" class="danger">üö™ –í—ã–π—Ç–∏</button>
</div>
<div class="container" style="display:none;" id="ratesContainer">
  <h2>üí∞ –¢–∞—Ä–∏—Ñ—ã –∏ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã</h2>
  <!-- üéØ –§–ò–õ–¨–¢–†–´ -->
  <div id="ratesFilters" style="display: flex; gap: 10px; margin: 16px 0;">
    <select id="filterOperation" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>
    </select>
    <select id="filterKey" style="flex:1; padding: 10px; font-size: 16px;">
      <option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>
    </select>
</div>
  <!-- üìã –°–ü–ò–°–û–ö –¢–ê–†–ò–§–û–í -->
  <div id="ratesTable"></div>
</div>
  <!-- –¢–∞–±–ª–∏—Ü–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
</div>
<!-- üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å -->
<div class="container" id="adminContainer" style="display:none;">
  <h2>üõ†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

<!-- üìÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥ -->
<div style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 10px;">
  <label style="flex:1 1 200px;">–ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="unifiedStart">
  </label>
  <label style="flex:1 1 200px;">–ø–æ:
    <input type="date" id="unifiedEnd">
  </label>
</div>

  <!-- üîò –î–µ–π—Å—Ç–≤–∏—è -->
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 16px;">
  <button onclick="loadShiftStats()">üìä –°–≤–æ–¥–∫–∞ –ø–æ —Å–º–µ–Ω–µ</button>
  <button onclick="analyzePackers()" id="analyzeBtn">üßÆ –ê–Ω–∞–ª–∏–∑ —à—Ç–∞—Ç–Ω—ã—Ö —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</button>
  <button onclick="openUpdateAllModal()" id="updateAllBtn" style="background:#8b5cf6;">üîÑ –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
  <button onclick="runCustomReport()" id="reportBtn">üìÜ –û—Ç—á—ë—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥</button>
  <button onclick="loadSeniorsReport()" id="seniorsReportBtn" style="background:#8b5cf6;">üë®‚Äçüíº –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</button>
  <button onclick="openSalaryExportModal()" id="salaryExportBtn" style="background:#10b981;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã HR</button>
</div>

<!-- üßæ –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤ -->
<div id="reportContainer" style="margin-top: 20px;"></div>

<!-- üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
<div id="shiftStatsOutput" style="margin-top:20px;"></div>
<div id="packerAnalysis" style="margin-top:24px;"></div>

  <!-- üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
  <div id="shiftStatsOutput" style="margin-top:20px;"></div>
  <div id="packerAnalysis" style="margin-top:24px;"></div>

  <!-- üö™ –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
  <div style="margin-top: 40px; text-align: center; border-top: 1px solid #e5e7eb; padding-top: 20px;">
    <button onclick="handleLogout()" class="danger" style="background-color: #dc2626; width: auto; padding: 12px 24px;">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
  </div>
</div>

<!-- üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî –ø–µ—Ä–µ–º–µ—â—ë–Ω –í–ù–ï adminContainer -->
<div class="container" style="display:none;" id="mySalaryContainer">
  <h2>üíµ –ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞</h2>
  <label>üìÖ –ü–µ—Ä–∏–æ–¥ —Å:
    <input type="date" id="salaryStart">
  </label>
  <label style="margin-left:10px;">–ø–æ:
    <input type="date" id="salaryEnd">
  </label>
  <button id="mySalaryBtn" onclick="loadMySalary()">üìä –ü–æ–∫–∞–∑–∞—Ç—å</button>
  <div id="mySalaryOutput" style="margin-top:20px;"></div>
<p id="totalQty" style="text-align:center; font-weight:bold; margin-top:16px;"></p>
</div>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxJMnft9bmQL7xkLMsku-UIbKaGIL5phOzTnDf85KFZAvniWm1rQeQE1h5Tnj5W0MxD/exec";
let todayRecords = [];
let currentUser = "";
let currentShift = "";
let currentStatus = "";
 let allRates = [];
let allVolumes = []; // ‚Üê –¥–æ–±–∞–≤—å —ç—Ç–æ!
let currentUserRole = "user"; // ‚Üê –¥–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞

// ===== –§–£–ù–ö–¶–ò–ò –ê–ù–ò–ú–ê–¶–ò–ò –ö–ù–û–ü–û–ö =====

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ripple —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
function createRipple(event) {
  const button = event.currentTarget;
  const circle = document.createElement("span");
  const diameter = Math.max(button.clientWidth, button.clientHeight);
  const radius = diameter / 2;

  const rect = button.getBoundingClientRect();
  circle.style.width = circle.style.height = `${diameter}px`;
  circle.style.left = `${event.clientX - rect.left - radius}px`;
  circle.style.top = `${event.clientY - rect.top - radius}px`;
  circle.classList.add("ripple-effect");

  const ripple = button.getElementsByClassName("ripple-effect")[0];
  if (ripple) {
    ripple.remove();
  }

  button.appendChild(circle);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
function setButtonLoading(button, loading = true) {
  if (loading) {
    button.classList.add('loading');
    button.disabled = true;
  } else {
    button.classList.remove('loading');
    button.disabled = false;
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
function setButtonSuccess(button, duration = 2000) {
  const originalClass = button.className;
  const originalText = button.textContent;
  
  button.classList.add('success');
  button.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ!';
  
  setTimeout(() => {
    button.className = originalClass;
    button.textContent = originalText;
  }, duration);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function animateIn(element, animation = 'fadeIn') {
  element.style.opacity = '0';
  element.style.transform = 'translateY(20px)';
  element.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
  
  setTimeout(() => {
    element.style.opacity = '1';
    element.style.transform = 'translateY(0)';
  }, 50);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function initButtonAnimations() {
  // –î–æ–±–∞–≤–ª—è–µ–º ripple —ç—Ñ—Ñ–µ–∫—Ç –∫–æ –≤—Å–µ–º –∫–Ω–æ–ø–∫–∞–º
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', createRipple);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è ripple —ç—Ñ—Ñ–µ–∫—Ç–∞
    if (!button.style.position) {
      button.style.position = 'relative';
    }
    button.style.overflow = 'hidden';
  });

  // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ–∫—Ü–∏–π
  document.querySelectorAll('.container, .stat-card').forEach((element, index) => {
    setTimeout(() => {
      animateIn(element);
    }, index * 100);
  });
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è ripple —ç—Ñ—Ñ–µ–∫—Ç–∞
const rippleStyles = document.createElement('style');
rippleStyles.textContent = `
  .ripple-effect {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.6);
    transform: scale(0);
    animation: ripple-animation 0.6s linear;
    pointer-events: none;
  }

  @keyframes ripple-animation {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
  .fade-in {
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–Ω–æ–ø–æ–∫ */
  button.pulse {
    animation: pulseButton 1.5s infinite;
  }

  @keyframes pulseButton {
    0%, 100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
  }

  /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è floating –∫–Ω–æ–ø–æ–∫ */
  .floating-button {
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }
`;
document.head.appendChild(rippleStyles);

// –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
  
// === –õ–û–ì–ò–ö–ê: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ ===
const employeeStatusElement = document.getElementById("employeeStatus");
if (employeeStatusElement) {
  employeeStatusElement.addEventListener("change", function() {
  const status = this.value;
  const payTypeSelect = document.getElementById("profilePayType");
  const salaryBlock = document.getElementById("salaryBlock");

  if (status === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") {
    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ "–°–¥–µ–ª–∫–∞"
    payTypeSelect.innerHTML = '<option value="–°–¥–µ–ª–∫–∞">–°–¥–µ–ª–∫–∞</option>';
    payTypeSelect.value = "–°–¥–µ–ª–∫–∞";
    salaryBlock.style.display = "none";
    localStorage.setItem("profilePayType", "–°–¥–µ–ª–∫–∞");
    localStorage.removeItem("profileSalary");
  } else {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
    payTypeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option><option value="–°–¥–µ–ª–∫–∞">–°–¥–µ–ª–∫–∞</option><option value="–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞">–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞</option>';
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const savedPayType = localStorage.getItem("profilePayType") || "";
    payTypeSelect.value = savedPayType;
    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞"
    if (payTypeSelect.value === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      salaryBlock.style.display = "block";
    } else {
      salaryBlock.style.display = "none";
    }
  }
  });
}

// === –õ–û–ì–ò–ö–ê: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞" ===
const profilePayTypeElement = document.getElementById("profilePayType");
if (profilePayTypeElement) {
  profilePayTypeElement.addEventListener("change", async function() {
  const salaryBlock = document.getElementById("salaryBlock");
  const salaryInput = document.getElementById("profileSalary");
  if (this.value === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
    salaryBlock.style.display = "block";
    // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞
    const currentUser = localStorage.getItem("currentUser") || "";
    console.log(`üîç –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∫–ª–∞–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${currentUser}"`);
    
    try {
      const res = await fetch(`${scriptURL}?type=getSalary&employee=${encodeURIComponent(currentUser)}`);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();
      console.log(`üìä –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, data);
      
      const salary = data.salary || "";
      console.log(`üí∞ –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ–∫–ª–∞–¥: "${salary}"`);
      
      salaryInput.value = salary;
      localStorage.setItem("profileSalary", salary);
      
      if (!salary) {
        console.warn(`‚ö†Ô∏è –û–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${currentUser}"`);
      }
    } catch (err) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞:`, err);
      salaryInput.value = "";
      localStorage.removeItem("profileSalary");
    }
  } else {
    salaryBlock.style.display = "none";
    salaryInput.value = "";
    localStorage.removeItem("profileSalary");
  }
  });
}

}); // –ó–∞–∫—Ä—ã—Ç–∏–µ DOMContentLoaded



function isProfileComplete() {
  const packingModel = document.getElementById("profilePackingModel").value;
  return currentShift && currentStatus && packingModel;
}

// üîÑ –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–∑ localStorage
function restoreProfile() {
  const shiftType = localStorage.getItem("profileShiftType") || "";
  const status = localStorage.getItem("profileStatus") || "";
  const packingModel = localStorage.getItem("profilePackingModel") || "";
  const payType = localStorage.getItem("profilePayType") || "";
  const salary = localStorage.getItem("profileSalary") || "";

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");
  const packingModelSelect = document.getElementById("profilePackingModel");
  const payTypeSelect = document.getElementById("profilePayType");
  const salaryInput = document.getElementById("profileSalary");

  if (shiftSelect) shiftSelect.value = shiftType;
  if (statusSelect) statusSelect.value = status;
  if (packingModelSelect) packingModelSelect.value = packingModel;
  if (payTypeSelect) payTypeSelect.value = payType;
  if (salaryInput) salaryInput.value = salary;

  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
  currentShift = shiftType;
  currentStatus = status;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –æ–∫–ª–∞–¥–∞
  const salaryBlock = document.getElementById("salaryBlock");
  if (salaryBlock) {
    salaryBlock.style.display = (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") ? "block" : "none";
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–∫–ª–∞–¥–æ–∫
  if (currentUserRole !== "admin") {
    const isFilled = shiftType && status && packingModel && payType;
    const hint = document.getElementById("profileHint");
    const msg = document.getElementById("profileSaved");
    const tabApp = document.getElementById("tabApp");
    const tabMySalary = document.getElementById("tabMySalary");

    if (hint) hint.style.display = isFilled ? "none" : "block";
    if (msg) msg.style.display = isFilled ? "block" : "none";
    if (tabApp) {
      tabApp.disabled = !isFilled;
      tabApp.innerHTML = isFilled ? "üìã" : "üîí";
    }

    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞", –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∞—É—Ç—Å–æ—Ä—Å
    if (tabMySalary) {
      tabMySalary.style.display = (status === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") ? "none" : "inline-block";
    }
  }
}

function requireProfile() {
  if (!isProfileComplete()) {
    alert("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª");
    switchTab("profile");
    return false;
  }
  return true;
}


async function saveProfile() {
  const shiftSelect = document.getElementById("shiftType");
  const statusSelect = document.getElementById("employeeStatus");
  const packingModelSelect = document.getElementById("profilePackingModel");
  const payTypeSelect = document.getElementById("profilePayType");
  const salaryInput = document.getElementById("profileSalary");
  const saveBtn = document.querySelector('button[onclick="saveProfile()"]') || 
                  document.querySelector('#profileContainer button');

  // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
  if (saveBtn) {
    setButtonLoading(saveBtn, true);
  }

  const shiftValue = shiftSelect.value;
  const statusValue = statusSelect.value;
  const packingModel = packingModelSelect.value;
  const payType = payTypeSelect.value;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
  localStorage.setItem("profileShiftType", shiftValue);
  localStorage.setItem("profileStatus", statusValue);
  localStorage.setItem("profilePackingModel", packingModel);
  localStorage.setItem("profilePayType", payType);

  // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞", –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –æ–∫–ª–∞–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞
  let salary = "";
  if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
    try {
      const currentUser = localStorage.getItem("currentUser") || "";
      console.log(`üîç saveProfile: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∫–ª–∞–¥–∞ –¥–ª—è "${currentUser}"`);
      
      const res = await fetch(`${scriptURL}?type=getSalary&employee=${encodeURIComponent(currentUser)}`);
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }
      
      const data = await res.json();
      console.log(`üìä saveProfile: –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:`, data);
      
      salary = data.salary || "";
      console.log(`üí∞ saveProfile: –ü–æ–ª—É—á–µ–Ω–Ω—ã–π –æ–∫–ª–∞–¥: "${salary}"`);
      
      if (!salary) {
        console.warn(`‚ö†Ô∏è saveProfile: –û–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${currentUser}"`);
      }
    } catch (err) {
      console.error(`‚ùå saveProfile: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–∫–ª–∞–¥–∞:`, err);
      salary = "";
    }
    salaryInput.value = salary;
    localStorage.setItem("profileSalary", salary);
    document.getElementById("salaryBlock").style.display = "block";
  } else {
    salaryInput.value = "";
    localStorage.removeItem("profileSalary");
    document.getElementById("salaryBlock").style.display = "none";
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    const isFilled = shiftValue && statusValue && packingModel && payType;
    const hint = document.getElementById("profileHint");
    const msg = document.getElementById("profileSaved");
    const tabApp = document.getElementById("tabApp");
    const tabMySalary = document.getElementById("tabMySalary");

    hint.style.display = isFilled ? "none" : "block";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω
    if (isFilled) {
      msg.style.display = "block";
      msg.textContent = "‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω! –î–æ—Å—Ç—É–ø –∫ –≤–∫–ª–∞–¥–∫–∞–º –æ—Ç–∫—Ä—ã—Ç.";
      // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => msg.style.display = "none", 3000);
    } else {
      msg.style.display = "none";
    }
    
    tabApp.disabled = !isFilled;
    tabApp.innerHTML = isFilled ? "üìã" : "üîí";

    // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞", –µ—Å–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∞—É—Ç—Å–æ—Ä—Å
    if (tabMySalary) {
      tabMySalary.style.display = (statusValue === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥") ? "none" : "inline-block";
    }
  }

  // <<< –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è >>>
  currentShift = shiftValue;
  currentStatus = statusValue;

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  if (saveBtn) {
    setButtonSuccess(saveBtn, 1500);
    setTimeout(() => setButtonLoading(saveBtn, false), 1500);
  }
}

// –§—É–Ω–∫—Ü–∏—è switchTab –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è





async function handleLogin() {
  console.log("üîê handleLogin() –≤—ã–∑–≤–∞–Ω");

  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const errorElem = document.getElementById("loginError");
  const loginBtn = document.querySelector('button[onclick="handleLogin()"]') || 
                   document.querySelector('.login-container button');
  
  errorElem.textContent = "";

  // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
  if (loginBtn) {
    setButtonLoading(loginBtn, true);
  }

  try {
    const res = await fetch(`${scriptURL}?type=auth&login=${encodeURIComponent(login)}&password=${encodeURIComponent(password)}`);
    const data = await res.json();

    if (data.status === "ok") {
      currentUser = login;
      currentUserRole = data.role || 'user';

      localStorage.setItem("currentUser", login);
      localStorage.setItem("currentUserRole", currentUserRole);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–≤–∫–ª–∞–¥–∫—É –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      const tabAdmin = document.getElementById("tabAdmin");
      tabAdmin.style.display = (currentUserRole === "admin") ? "block" : "none";

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –ü–ï–†–ï–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("tabContainer").style.display = "block";
      document.querySelector('[name="employeeName"]').value = currentUser;
      
      // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
      if (currentUserRole === "admin") {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
        const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
        tabButtons.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) btn.style.display = "none";
        });
        
        document.getElementById("bottomNav").style.display = "flex";
        switchTab("admin"); // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
      } else {
        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
        document.getElementById("bottomNav").style.display = "flex";
        switchTab("profile"); // ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        
        // üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        await Promise.all([
          loadVolumes(),
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords(),
          loadOperationFilter(),
          loadRatesTable(),
          loadPackingModels()
        ]);
        
        restoreProfile(); // üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ localStorage
        // –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ - —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
      }

      // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ) - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
      if (currentUserRole === "admin") {
        loadAllDictionariesInBackground();
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ö–æ–¥–∞
      if (loginBtn) {
        setButtonSuccess(loginBtn, 1000);
        setTimeout(() => setButtonLoading(loginBtn, false), 1000);
      }

    } else {
      errorElem.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ PIN-–∫–æ–¥";
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ—à–∏–±–∫–∏
      if (loginBtn) {
        loginBtn.classList.add('danger');
        loginBtn.textContent = '‚ùå –û—à–∏–±–∫–∞!';
        setTimeout(() => {
          loginBtn.classList.remove('danger');
          loginBtn.textContent = 'üîê –í–æ–π—Ç–∏';
          setButtonLoading(loginBtn, false);
        }, 2000);
      }
    }
  } catch (err) {
    errorElem.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if (loginBtn) {
      loginBtn.classList.add('danger');
      loginBtn.textContent = 'üì° –ù–µ—Ç —Å–≤—è–∑–∏!';
      setTimeout(() => {
        loginBtn.classList.remove('danger');
        loginBtn.textContent = 'üîê –í–æ–π—Ç–∏';
        setButtonLoading(loginBtn, false);
      }, 2000);
    }
  }
}


function handleLogout() {
  // üîÑ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
  currentUser = "";
  currentUserRole = "user";
  currentShift = "";
  currentStatus = "";

  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentUserRole");

  // üîê –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
  const loginInput = document.getElementById("login");
  const passwordInput = document.getElementById("password");
  loginInput.value = "";
  passwordInput.value = "";
  loginInput.focus();

  // üë§ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
  document.querySelector('[name="employeeName"]').value = "";
  document.getElementById("shiftType").value = "";
  document.getElementById("employeeStatus").value = "";
  document.getElementById("profileSaved").style.display = "none";
  document.getElementById("profileHint").style.display = "block";

  // üîí –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É—á—ë—Ç–∞
  const tabApp = document.getElementById("tabApp");
  tabApp.disabled = true;
  tabApp.innerHTML = "üîí";

  // ‚ùå –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  closeStats(); // –æ—á–∏—â–∞–µ—Ç statsCards, totalWage –∏ statsLogs

  // üìâ –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  document.getElementById("operationFilter").value = "";
  document.getElementById("statsDate").value = "";

  // üíµ –û—á–∏—Å—Ç–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  document.getElementById("mySalaryOutput").innerHTML = "";
  document.getElementById("totalQty").textContent = "";
  document.getElementById("salaryStart").value = "";
  document.getElementById("salaryEnd").value = "";

  // üßº –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  const containers = [
    "loginContainer",
    "tabContainer",
    "appContainer",
    "statsContainer",
    "profileContainer",
    "ratesContainer",
    "adminContainer",
    "mySalaryContainer"
  ];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = (id === "loginContainer") ? "block" : "none";
  });

  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
  const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
  tabButtons.forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.style.display = "inline-block";
  });

  // üßΩ –°–±—Ä–æ—Å –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  const modal = document.getElementById("editModal");
  if (modal) modal.style.display = "none";

  // üëá –°–∫—Ä—ã—Ç–∏–µ –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é
  const nav = document.getElementById("bottomNav");
  nav.style.opacity = "0";
  setTimeout(() => {
    nav.style.display = "none";
    nav.style.opacity = "1";
  }, 200);
}

  async function loadTodayRecords() {
    const res = await fetch(`${scriptURL}?type=records`);
    const data = await res.json();
    todayRecords = data.records || [];
  }

function loadMySalary() {
  withLoading("mySalaryBtn", async () => {
    const employee = localStorage.getItem("currentUser") || "";
    const start = document.getElementById("salaryStart").value;
    const end = document.getElementById("salaryEnd").value;

    if (!employee || !start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=mySalary&employee=${encodeURIComponent(employee)}&start=${start}&end=${end}`);
      const data = await res.json();

      const container = document.getElementById("mySalaryOutput");
      const totalQtyBlock = document.getElementById("totalQty");

      if (!data.records || data.records.length === 0) {
        container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>";
        totalQtyBlock.textContent = "";
        return;
      }

      // üì¶ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
      const grouped = {};
      let totalQty = 0;
      let totalWage = 0;

      data.records.forEach(r => {
        const date = formatDate(r.date);
        if (!grouped[date]) {
          grouped[date] = { qty: 0, wage: 0, effs: [] };
        }
        grouped[date].qty += r.quantity || 0;
        grouped[date].wage += r.wage || 0;
        if (r.efficiency !== undefined && r.efficiency !== null) {
          grouped[date].effs.push(r.efficiency);
        }

        totalQty += r.quantity || 0;
        totalWage += r.wage || 0;
      });

      let html = `
        <table style="width:100%; border-collapse: collapse; font-size:14px;">
          <thead style="background:#f3f4f6;">
            <tr>
              <th style="padding:8px; border:1px solid #ccc;">üìÖ –î–∞—Ç–∞</th>
              <th style="padding:8px; border:1px solid #ccc;">üî¢ –ö–æ–ª-–≤–æ</th>
              <th style="padding:8px; border:1px solid #ccc;">‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
              <th style="padding:8px; border:1px solid #ccc;">üí∞ –°—É–º–º–∞</th>
            </tr>
          </thead>
          <tbody>
      `;

      Object.entries(grouped).forEach(([date, stats]) => {
        const avgEff = stats.effs.length
          ? Math.round(stats.effs.reduce((a, b) => a + b, 0) / stats.effs.length)
          : "-";
        html += `
          <tr>
            <td style="padding:6px; border:1px solid #ccc;">${date}</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.qty}</td>
            <td style="padding:6px; border:1px solid #ccc;">${avgEff}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${stats.wage.toFixed(2)} ‚ÇΩ</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
      totalQtyBlock.textContent = `üì¶ –í—Å–µ–≥–æ: ${totalQty} —à—Ç | üíµ –°—É–º–º–∞: ${totalWage.toFixed(2)} ‚ÇΩ`;

    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err.message);
    }
  });
}

function formatDate(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}




  async function loadVolumes() {
  const res = await fetch(`${scriptURL}?type=volumes`);
  const data = await res.json();
  allVolumes = data.volumes.map(v => ["", v]); // ‚Üê —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ [–æ–ø–µ—Ä–∞—Ü–∏—è, –æ–±—ä—ë–º] (–∑–∞–≥–ª—É—à–∫–∞)

  const select = document.querySelector('[name="volume"]');
  select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
  data.volumes.forEach(val => {
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}

  async function loadOperations() {
    const res = await fetch(`${scriptURL}?type=operations`);
    const data = await res.json();
    const select = document.querySelector('[name="operationType"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
    data.operations.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
    select.addEventListener("change", () => handleOperationChange(select.value));
  }

  async function loadSetNumbers() {
    const res = await fetch(`${scriptURL}?type=sets`);
    const data = await res.json();
    const select = document.querySelector('[name="setNumber"]');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
    data.sets.forEach(val => {
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

async function deleteRecord(index) {
  if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) return;

  const res = await fetch(`${scriptURL}?type=deleteRecord&index=${index}`);
  const data = await res.json();

  alert(data.message || "–£–¥–∞–ª–µ–Ω–æ");
  if (data.status === "success") {
    loadStats();
  }
}

  function handleOperationChange(operation) {
  const setField = document.getElementById("setNumberField");
  const volumeLabel = document.getElementById("volumeLabel");
  const volumeSelect = document.querySelector('[name="volume"]');
  const setSelect = document.querySelector('[name="setNumber"]');

  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞
  if (operation === '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
    setField.style.display = "block";
    setSelect.required = true;
    volumeLabel.style.display = "none";
    volumeSelect.required = false;
    volumeSelect.value = "";
  } else {
    setField.style.display = "none";
    setSelect.required = false;
    setSelect.value = "";
    volumeLabel.style.display = "block";
    volumeSelect.required = true;
  }

  // === üîí –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ ‚Äî –æ–±—ä—ë–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ===
 if (operation === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
  volumeSelect.innerHTML = '<option value="–û–±—â–∞—è">–û–±—â–∞—è</option>';
  volumeSelect.value = "–û–±—â–∞—è";
  volumeSelect.readOnly = true; // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–µ–ª–∞–π—Ç–µ –Ω–∏—á–µ–≥–æ, —á—Ç–æ–±—ã –ø–æ–ª–µ –±—ã–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  return;
}

  // === üìÇ –ü–æ–¥–≥—Ä—É–∑–∫–∞ –æ–±—ä—ë–º–æ–≤ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ ===
  volumeSelect.disabled = false;
  volumeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';

  // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±—ä—ë–º—ã –ø–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ (allRates –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –∑–∞—Ä–∞–Ω–µ–µ)
  const relatedKeys = Array.from(
    new Set(
      allRates
        .filter(rate => rate.operation === operation)
        .map(rate => rate.key)
    )
  );

  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã
  relatedKeys.forEach(key => {
    const opt = document.createElement("option");
    opt.value = key;
    opt.textContent = key;
    volumeSelect.appendChild(opt);
  });
}


function updateRateDisplay() {
  const operationType = document.querySelector('[name="operationType"]').value;
  const volume = document.querySelector('[name="volume"]').value;
  const setNumber = document.querySelector('[name="setNumber"]').value;
  const quantity = Number(document.querySelector('[name="quantity"]').value) || 0;

  const startTime = document.querySelector('[name="startTime"]').value;
  const endTime = document.querySelector('[name="endTime"]').value;

  const key = (operationType.includes("–°–±–æ—Ä–∫–∞")) ? setNumber : volume;

  // –ù–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ç–∞—Ä–∏—Ñ
  const matched = allRates.find(r => r.operation === operationType && r.key === key);

  const block = document.getElementById("rateInfo");
  const norm = document.getElementById("normDisplay");
  const rate = document.getElementById("rateDisplay");

  const calcBlock = document.getElementById("calcBlock");
  const wageDisplay = document.getElementById("wageDisplay");
  const efficiencyDisplay = document.getElementById("efficiencyDisplay");

  if (matched) {
    norm.textContent = matched.normPerHour;

    // --- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ —Å —É—á—ë—Ç–æ–º —Ç–∏–ø–∞ –æ–ø–ª–∞—Ç—ã –∏ FBS ---
    const packingModel = (document.getElementById("profilePackingModel")?.value || "").toLowerCase();
    const payType = localStorage.getItem("profilePayType") || "–°–¥–µ–ª–∫–∞";
    let ratePerUnit = 0;

    if (payType === "–û–∫–ª–∞–¥ + —Å–¥–µ–ª–∫–∞") {
      // –û–∫–ª–∞–¥+—Å–¥–µ–ª–∫–∞: –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã
      if (packingModel.includes("fbs") && matched.rateFBSDeal !== undefined) {
        ratePerUnit = Number(matched.rateFBSDeal);
      } else if (matched.rateDeal !== undefined) {
        ratePerUnit = Number(matched.rateDeal);
      }
    } else {
      // –û–±—ã—á–Ω–∞—è —Å–¥–µ–ª–∫–∞
      if (packingModel.includes("fbs") && matched.rateFBS !== undefined) {
        ratePerUnit = Number(matched.rateFBS);
      } else if (matched.ratePerUnit !== undefined) {
        ratePerUnit = Number(matched.ratePerUnit);
      }
    }

    rate.textContent = ratePerUnit ? ratePerUnit.toFixed(2) + " ‚ÇΩ" : "-";

    const totalPay = quantity * ratePerUnit;

    let durationMin = 0;
    if (startTime && endTime) {
      const [sh, sm] = startTime.split(":").map(Number);
      const [eh, em] = endTime.split(":").map(Number);
      durationMin = (eh * 60 + em) - (sh * 60 + sm);
      if (durationMin < 0) durationMin += 1440;
    }

    let efficiency = "-";
    if (durationMin > 0 && matched.normPerHour > 0) {
      const expected = (matched.normPerHour / 60) * durationMin;
      efficiency = ((quantity / expected) * 100).toFixed(0) + " %";
    }

    wageDisplay.textContent = totalPay.toFixed(2) + " ‚ÇΩ";
    efficiencyDisplay.textContent = efficiency;

    block.style.display = "block";
    calcBlock.style.display = "block";
  } else {
    norm.textContent = "-";
    rate.textContent = "-";
    block.style.display = "none";
    calcBlock.style.display = "none";
  }
}

document.querySelector('[name="operationType"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="volume"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="setNumber"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="quantity"]').addEventListener("input", updateRateDisplay);
document.querySelector('[name="startTime"]').addEventListener("change", updateRateDisplay);
document.querySelector('[name="endTime"]').addEventListener("change", updateRateDisplay);
document.getElementById("profilePackingModel").addEventListener("change", updateRateDisplay);

document.getElementById("dataForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  const result = document.getElementById("result");

  // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å —É–ø–∞–∫–æ–≤–∫–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  const packingModel = document.getElementById("profilePackingModel").value;
  formData.append("packingModel", packingModel);

  // –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    formData.set("duration", duration);
    document.querySelector('[name="duration"]').value = duration;
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
  formData.append("shiftType", currentShift);
  formData.append("employeeStatus", currentStatus);
  formData.append("payType", localStorage.getItem("profilePayType") || "");
  formData.append("salary", localStorage.getItem("profileSalary") || "");

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã (–ª–æ–∫–∞–ª—å–Ω–∞—è)
  await loadTodayRecords();
  const payload = {
    employeeName: formData.get("employeeName")?.trim(),
    quantity: formData.get("quantity")?.trim(),
    startTime: formData.get("startTime")?.trim(),
    endTime: formData.get("endTime")?.trim(),
    volume: formData.get("volume")?.trim(),
    operationType: formData.get("operationType")?.trim(),
    orderNumber: formData.get("orderNumber")?.trim(),
    setNumber: formData.get("setNumber")?.trim(),
    shiftType: currentShift,
    employeeStatus: currentStatus
  };

  const isDuplicate = todayRecords.some(rec => {
    const isSame =
      rec.employeeName === payload.employeeName &&
      rec.quantity === payload.quantity &&
      rec.startTime === payload.startTime &&
      rec.endTime === payload.endTime &&
      rec.operationType === payload.operationType &&
      rec.orderNumber === payload.orderNumber &&
      rec.setNumber === payload.setNumber;

    if (!isSame) return false;
    if (payload.operationType !== '–°–±–æ—Ä–∫–∞ "–ù–∞–±–æ—Ä–∞"') {
      return rec.volume === payload.volume;
    }
    return true;
  });

  const submitBtn = form.querySelector('button[type="submit"]');
  if (isDuplicate) {
    result.textContent = "‚ö†Ô∏è –¢–∞–∫–∞—è –∑–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)";
    result.style.display = "block";
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
    form.reset();
    document.querySelector('[name="employeeName"]').value = currentUser;
    handleOperationChange("");
    updateRateDisplay();
    return;
  }

  // === –ö–õ–Æ–ß–ï–í–û–ï: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ URLSearchParams ===
  const params = new URLSearchParams();
  formData.forEach((value, key) => {
    params.append(key, value);
  });

  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  result.style.display = "none";

  try {
    const response = await fetch(scriptURL, {
      method: "POST",
      body: params
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const resultData = await response.json();
    result.textContent = resultData.message;
    result.style.display = "block";

    if (resultData.status === "success") {
      form.reset();
      document.querySelector('[name="employeeName"]').value = currentUser;
      handleOperationChange("");
      updateRateDisplay();
      await loadTodayRecords();
    }
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
    result.textContent = "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + error.message;
    result.style.display = "block";
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  }
});


async function loadRatesTable() {
  const res = await fetch(`${scriptURL}?type=rates`);
  const data = await res.json();
  allRates = data.rates || [];

  const opFilter = document.getElementById("filterOperation");
  const keyFilter = document.getElementById("filterKey");
  const container = document.getElementById("ratesTable");

  // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  opFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  keyFilter.innerHTML = '<option value="">-- –í—Å–µ –æ–±—ä—ë–º—ã / –∞—Ä—Ç–∏–∫—É–ª—ã --</option>';

  // –§–∏–ª—å—Ç—Ä—É–µ–º –ª–∏—à–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
  const filteredRates = allRates.filter(r =>
    r.operation !== "–°—Ç–∞–≤–∫–∞_–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥" && r.operation !== "–°—Ç–∞–≤–∫–∞_—à—Ç–∞—Ç"
  );

  const operations = [...new Set(filteredRates.map(r => r.operation))];
  const keys = [...new Set(filteredRates.map(r => r.key))];

  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opFilter.appendChild(opt);
  });

  keys.forEach(k => {
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = k;
    keyFilter.appendChild(opt);
  });

  function renderFilteredRates() {
    const selectedOp = opFilter.value;
    const selectedKey = keyFilter.value;

    const filtered = filteredRates.filter(r =>
      (!selectedOp || r.operation === selectedOp) &&
      (!selectedKey || r.key === selectedKey)
    );

    if (!filtered.length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</p>";
      return;
    }

    let html = `
      <div class="table-scroll">
      <table style="width:100%; border-collapse:collapse; font-size:14px; min-width:700px;">
        <thead>
          <tr style="background:#f3f4f6;">
            <th>üè∑Ô∏è –û–ø–µ—Ä–∞—Ü–∏—è</th>
            <th>üì¶ –û–±—ä—ë–º / –ê—Ä—Ç–∏–∫—É–ª</th>
            <th>‚è±Ô∏è –ù–æ—Ä–º–∞ –≤ —á–∞—Å</th>
            <th>üí∞ –¢–∞—Ä–∏—Ñ/—à—Ç (—Å–¥–µ–ª—å–Ω–∞—è)</th>
            <th>üöö –¢–∞—Ä–∏—Ñ FBS/—à—Ç (—Å–¥–µ–ª—å–Ω–∞—è)</th>
            <th>üßæ –¢–∞—Ä–∏—Ñ/—à—Ç (–æ–∫–ª–∞–¥+—Å–¥–µ–ª–∫–∞)</th>
            <th>üööüßæ –¢–∞—Ä–∏—Ñ FBS/—à—Ç (–æ–∫–ª–∞–¥+—Å–¥–µ–ª–∫–∞)</th>
          </tr>
        </thead>
        <tbody>
    `;

    filtered.forEach(r => {
      html += `
        <tr>
          <td>${r.operation}</td>
          <td>${r.key}</td>
          <td>${r.normPerHour}</td>
          <td>${r.ratePerUnit.toFixed(2)} ‚ÇΩ</td>
          <td>${r.rateFBS.toFixed(2)} ‚ÇΩ</td>
          <td>${r.rateDeal.toFixed(2)} ‚ÇΩ</td>
          <td>${r.rateFBSDeal.toFixed(2)} ‚ÇΩ</td>
        </tr>
      `;
    });

    html += '</tbody></table></div>';
    container.innerHTML = html;
  }

  opFilter.onchange = renderFilteredRates;
  keyFilter.onchange = renderFilteredRates;

  renderFilteredRates(); // –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
}

async function loadOperationFilter() {
  const res = await fetch(`${scriptURL}?type=operations`);
  const data = await res.json();
  const filter = document.getElementById("operationFilter");

  filter.innerHTML = '<option value="">-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ --</option>';
  data.operations.forEach(op => {
    const option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    filter.appendChild(option);
  });
}

function openEditModal(index, record) {
  const form = document.getElementById("editForm");

  form.rowIndex.value = index;
  form.employeeName.value = currentUser;
  form.orderNumber.value = record.orderNumber || "";
  form.shiftType.value = currentShift;
  form.employeeStatus.value = currentStatus;

  form.quantity.value = record.quantity;
  form.startTime.value = record.startTime;
  form.endTime.value = record.endTime;

  document.getElementById("editOperation").value = record.operationType || "";
  document.getElementById("editVolumeSelect").value = record.volume || "";
  document.getElementById("editSetNumberSelect").value = record.setNumber || "";

  // —Ç—Ä–∏–≥–≥–µ—Ä–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—è –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  document.getElementById("editOperation").dispatchEvent(new Event("change"));

  document.getElementById("editModal").style.display = "block";
}

async function loadEditFormDictionaries() {
  // –û–ø–µ—Ä–∞—Ü–∏–∏
  const resOp = await fetch(`${scriptURL}?type=operations`);
  const operations = (await resOp.json()).operations || [];
  const opSelect = document.getElementById("editOperation");
  opSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—é --</option>';
  operations.forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    opSelect.appendChild(opt);
  });

  // –û–±—ä—ë–º—ã
  const resVol = await fetch(`${scriptURL}?type=volumes`);
  const volumes = (await resVol.json()).volumes || [];
  const volSelect = document.getElementById("editVolumeSelect");
  volSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';
  volumes.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    volSelect.appendChild(opt);
  });

  // –ê—Ä—Ç–∏–∫—É–ª—ã –Ω–∞–±–æ—Ä–æ–≤
  const resSet = await fetch(`${scriptURL}?type=sets`);
  const sets = (await resSet.json()).sets || [];
  const setSelect = document.getElementById("editSetNumberSelect");
  setSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –∞—Ä—Ç–∏–∫—É–ª --</option>';
  sets.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    setSelect.appendChild(opt);
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞/–Ω–∞–±–æ—Ä–∞
  opSelect.addEventListener("change", () => {
    const isSet = opSelect.value.includes("–°–±–æ—Ä–∫–∞");
    document.getElementById("editVolumeLabel").style.display = isSet ? "none" : "block";
    volSelect.required = !isSet;
    document.getElementById("editSetNumberField").style.display = isSet ? "block" : "none";
  });
}

async function submitEditForm() {
  const form = document.getElementById("editForm");
  const formData = new FormData(form);
  const params = new URLSearchParams();

  formData.forEach((value, key) => {
    params.append(key, value);
  });

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  params.set("type", "editRecord");

  // üëá –ü–µ—Ä–µ—Å—á—ë—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≤–∞–∂–Ω–æ!)
  const start = formData.get("startTime");
  const end = formData.get("endTime");
  if (start && end) {
    const [sh, sm] = start.split(":").map(Number);
    const [eh, em] = end.split(":").map(Number);
    let minutes = (eh * 60 + em) - (sh * 60 + sm);
    if (minutes < 0) minutes += 1440;
    const duration = `${Math.floor(minutes / 60)} —á ${minutes % 60} –º–∏–Ω`;
    params.set("duration", duration);
  }

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params,
    });

    const data = await res.json();
    if (data.status === "success") {
      alert(data.message || "–û–±–Ω–æ–≤–ª–µ–Ω–æ");
      closeEditModal();
      await loadStats();
    } else {
      alert(data.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
    }
  } catch (err) {
    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.message);
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function getVolumesForOperation(operation) {
  if (!Array.isArray(allVolumes)) return [];

  return allVolumes
    .filter(item => item[0] === operation)
    .map(item => item[1])
    .filter((value, index, self) => self.indexOf(value) === index);
}


function closeStats() {
  document.getElementById("statsCards").innerHTML = "";
  document.getElementById("totalWage").textContent = "";
  document.getElementById("statsLogs").innerHTML = "";

  const closeBtn = document.getElementById("closeStatsBtn");
  if (closeBtn) closeBtn.style.display = "none";
}

let isStatsLoading = false;

async function loadStats() {
  if (isStatsLoading) return;
  isStatsLoading = true;

  const showBtn = document.getElementById("showStatsBtn");
  if (showBtn) showBtn.disabled = true;

  try {
    const selectedOperation = document.getElementById("operationFilter").value;
    const date = document.getElementById("statsDate").value;

    if (!currentUser) {
      alert("‚ùó–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.");
      return;
    }

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    closeStats();

    const res = await fetch(`${scriptURL}?type=stats&date=${encodeURIComponent(date)}&employee=${encodeURIComponent(currentUser)}`);
    const data = await res.json();

    const container = document.getElementById("statsCards");
    const totalElem = document.getElementById("totalWage");
    const logElem = document.getElementById("statsLogs");

    if (!data.records || !data.records.length) {
      container.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</p>';
      return;
    }

    let totalWage = 0;
    let totalEfficiency = 0;
    let efficiencyCount = 0;

    const filtered = selectedOperation
      ? data.records.filter(r => r.operationType === selectedOperation)
      : data.records;

    filtered.forEach(rec => {
      const wage = rec.wage || 0;
      totalWage += wage;

      if (rec.efficiency !== null && rec.efficiency !== undefined) {
        totalEfficiency += rec.efficiency;
        efficiencyCount++;
      }

      const card = document.createElement("div");
      card.className = "stat-card";
      card.innerHTML = `
        <p><strong>üïí –í—Ä–µ–º—è:</strong> ${rec.startTime} ‚Äì ${rec.endTime}</p>
        <p><strong>üîß –û–ø–µ—Ä–∞—Ü–∏—è:</strong> ${rec.operationType}</p>
        <p><strong>üì¶ –û–±—ä—ë–º:</strong> ${rec.volume || "-"}</p>
        <p><strong>üß© –ù–∞–±–æ—Ä:</strong> ${rec.setNumber || "-"}</p>
        <p><strong>üî¢ –ö–æ–ª-–≤–æ:</strong> ${rec.quantity}</p>
        <p><strong>‚öôÔ∏è –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${rec.efficiency ?? "-"}%</p>
        <p><strong>‚è± –ù–æ—Ä–º–∞ –≤ —á–∞—Å:</strong> ${rec.normPerHour ?? "-"}</p>
        <p><strong>üí∞ –¢–∞—Ä–∏—Ñ –∑–∞ —à—Ç:</strong> ${rec.ratePerUnit?.toFixed(2) ?? "-"} ‚ÇΩ</p>
        ${rec.bonusPercent ? `<p><strong>üéÅ –ë–æ–Ω—É—Å:</strong> ${rec.bonusIcon || "üéÅ"} ${rec.bonusPercent}</p>` : ""}
        <p><strong>üí∏ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ:</strong> ${wage.toFixed(2)} ‚ÇΩ</p>
      `;

      const today = new Date().toISOString().split("T")[0];
      if (rec.rowIndex !== undefined && date === today) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å";
        editBtn.onclick = () => openEditModal(rec.rowIndex, rec);
        card.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóë –£–¥–∞–ª–∏—Ç—å";
        delBtn.className = "danger";
        delBtn.style.marginLeft = "10px";
        delBtn.onclick = () => deleteRecord(rec.rowIndex);
        card.appendChild(delBtn);
      }

      container.appendChild(card);
    });

    const avgEff = efficiencyCount ? Math.round(totalEfficiency / efficiencyCount) : "-";
    totalElem.textContent = `üíµ –í—Å–µ–≥–æ: ${totalWage.toFixed(2)} ‚ÇΩ | ‚öôÔ∏è –°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${avgEff}%`;

    if (selectedOperation) {
      totalElem.textContent += ` | –§–∏–ª—å—Ç—Ä: ${selectedOperation}`;
    }

    if (data.logs && data.logs.length) {
      logElem.innerHTML = `
        <h4>üîç –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h4>
        <pre style="font-size:13px; background:#f3f4f6; padding:10px; border-radius:8px; overflow-x:auto;">${data.logs.join('\n')}</pre>
      `;
    }

    const closeBtn = document.getElementById("closeStatsBtn");
    if (closeBtn) closeBtn.style.display = "inline-block";

  } catch (error) {
    alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏");
    console.error(error);
  } finally {
    isStatsLoading = false;
    if (showBtn) showBtn.disabled = false;
  }
}



window.addEventListener("DOMContentLoaded", async () => {
  await loadEditFormDictionaries();
  await loadPackingModels();

  const savedUser = localStorage.getItem("currentUser");
  const savedRole = localStorage.getItem("currentUserRole");

  // ‚õî –°–±—Ä–æ—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞
  if (savedUser || savedRole) {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentUserRole");
  }

  if (!currentUser) {
    document.getElementById("login").focus();
    document.getElementById("loginContainer").style.display = "block";
    document.getElementById("tabContainer").style.display = "none";
    document.getElementById("profileContainer").style.display = "none";
    document.getElementById("bottomNav").style.display = "none";
    return;
  }

  // üë§ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
  if (currentUserRole === "admin") {
    document.getElementById("tabAdmin").style.display = "block";
    
    // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –∫—Ä–æ–º–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
    const tabButtons = ["tabProfile", "tabApp", "tabStats", "tabRates", "tabMySalary"];
    tabButtons.forEach(id => {
      const btn = document.getElementById(id);
      if (btn) btn.style.display = "none";
    });
    
    document.querySelector('[name="employeeName"]').value = currentUser;
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("tabContainer").style.display = "block";
    document.getElementById("adminContainer").style.display = "block";
    document.getElementById("bottomNav").style.display = "flex";
  } else {
    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    document.querySelector('[name="employeeName"]').value = currentUser;
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("tabContainer").style.display = "block";
    document.getElementById("profileContainer").style.display = "block";
    document.getElementById("bottomNav").style.display = "flex";
  }

  // üíµ –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É ¬´–ú–æ—è –∑–∞—Ä–ø–ª–∞—Ç–∞¬ª –¥–ª—è –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ (–Ω–µ –¥–ª—è –∞–¥–º–∏–Ω–∞)
  if (currentUserRole !== "admin") {
    const tabMySalary = document.getElementById("tabMySalary");
    if (currentStatus === "–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥" && tabMySalary) {
      tabMySalary.style.display = "none";
    }
  }

  // üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    await Promise.all([
      loadVolumes(),
      loadOperations(),
      loadSetNumbers(),
      loadTodayRecords(),
      loadOperationFilter(),
      loadRatesTable()
    ]);
    
    // üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ localStorage
    restoreProfile();
  }

  // üìä –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    document.getElementById("operationFilter").addEventListener("change", loadStats);

    // üìã –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞–Ω–Ω—ã—Ö
    // –¢–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
  }

  // üì¶ –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—ä—ë–º–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    const operationSelect = document.querySelector('[name="operationType"]');
    const volumeSelect = document.querySelector('[name="volume"]');

    if (operationSelect && volumeSelect) {
      operationSelect.addEventListener("change", () => {
        const selectedOp = operationSelect.value;

        if (selectedOp === "–ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–¥—É–∫—Ü–∏–∏ —à/–∫") {
          volumeSelect.innerHTML = '<option value="–û–±—â–∞—è">–û–±—â–∞—è</option>';
          volumeSelect.value = "–û–±—â–∞—è";
          volumeSelect.disabled = true;
        } else {
          volumeSelect.disabled = false;
          volumeSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏ –æ–±—ä—ë–º --</option>';

          const relatedKeys = Array.from(
            new Set(allRates.filter(r => r.operation === selectedOp).map(r => r.key))
          );

          relatedKeys.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            volumeSelect.appendChild(opt);
          });
        }
      });

      // üü° –û–±–Ω–æ–≤–∏—Ç—å —Å—Ä–∞–∑—É, –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
      operationSelect.dispatchEvent(new Event("change"));
    }
  }

  // ‚è± –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  if (currentUserRole !== "admin") {
    // –ü—Ä–æ—Å—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ localStorage –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    restoreProfile();
  }
});

async function loadPackingModels() {
  const select = document.getElementById("profilePackingModel");
  if (!select) return;
  select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
  try {
    const res = await fetch(`${scriptURL}?type=packingModels`);
    const data = await res.json();
    (data.models || []).forEach(model => {
      const opt = document.createElement("option");
      opt.value = model;
      opt.textContent = model;
      select.appendChild(opt);
    });
  } catch (err) {
    select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}

function openUpdateAllModal() {
  // –û—á–∏—Å—Ç–∫–∞
  document.getElementById("updateAllResult").textContent = "";
  document.getElementById("updateAllModal").style.display = "flex";
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
  const today = new Date();
  const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById("updateAllStart").value = weekAgo.toISOString().split("T")[0];
  document.getElementById("updateAllEnd").value = today.toISOString().split("T")[0];
}

function closeUpdateAllModal() {
  document.getElementById("updateAllModal").style.display = "none";
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞–º–∏ –≤—ã–±–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
function selectAllUpdates() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = true;
  document.getElementById("updateOutsourcingIndicators").checked = true;
}

function selectNoneUpdates() {
  document.getElementById("updateSeniorsSalary").checked = false;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

function selectOnlySeniors() {
  document.getElementById("updateSeniorsSalary").checked = true;
  document.getElementById("updateStaffIndicators").checked = false;
  document.getElementById("updateOutsourcingIndicators").checked = false;
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
async function submitSelectiveUpdate() {
  const btn = document.getElementById("submitUpdateAllBtn");
  const resultBox = document.getElementById("updateAllResult");

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...";
  resultBox.textContent = "";

  const start = document.getElementById("updateAllStart").value;
  const end = document.getElementById("updateAllEnd").value;

  if (!start || !end) {
    resultBox.textContent = "‚ùó –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const updateSeniors = document.getElementById("updateSeniorsSalary").checked;
  const updateStaff = document.getElementById("updateStaffIndicators").checked;
  const updateOutsourcing = document.getElementById("updateOutsourcingIndicators").checked;

  if (!updateSeniors && !updateStaff && !updateOutsourcing) {
    resultBox.textContent = "‚ùó –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  try {
    let resultMessage = "üöÄ –ù–∞—á–∏–Ω–∞—é –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...\n\n";
    resultBox.textContent = resultMessage;
    
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ)
    if (updateSeniors) {
      resultBox.textContent = resultMessage + "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω...";
      
      const seniorsResponse = await fetch(`${scriptURL}`, {
        method: 'POST',
        body: new URLSearchParams({
          type: 'processAllSeniorsForPeriod',
          start: start,
          end: end
        })
      });
      const seniorsData = await seniorsResponse.json();
      
      if (seniorsData.status === 'success') {
        resultMessage += `‚úÖ –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω—ã: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${seniorsData.processedCount || 0} –∑–∞–ø–∏—Å–µ–π\n`;
      } else {
        resultMessage += `‚ö†Ô∏è –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω—ã: ${seniorsData.message || '–æ—à–∏–±–∫–∞'}\n`;
      }
    } else {
      resultMessage += "‚è≠Ô∏è –ó–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω: –ø—Ä–æ–ø—É—â–µ–Ω–æ\n";
    }
    
    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ —á—Ç–æ-—Ç–æ –∏–∑ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π)
    if (updateStaff || updateOutsourcing) {
      resultBox.textContent = resultMessage + "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π...";
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
      let updateType = "";
      if (updateStaff && updateOutsourcing) {
        updateType = "both"; // –æ–±–Ω–æ–≤–ª—è–µ–º –∏ —à—Ç–∞—Ç –∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥
      } else if (updateStaff) {
        updateType = "staff"; // —Ç–æ–ª—å–∫–æ —à—Ç–∞—Ç
      } else if (updateOutsourcing) {
        updateType = "outsourcing"; // —Ç–æ–ª—å–∫–æ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥
      }
      
      const exportResponse = await fetch(`${scriptURL}?type=exportNow&date=${encodeURIComponent(start)}&endDate=${encodeURIComponent(end)}&components=${updateType}`);
      const exportResult = await exportResponse.text();
      
      if (exportResult.includes("‚úÖ")) {
        if (updateStaff && updateOutsourcing) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–∞ –∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        } else if (updateStaff) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        } else if (updateOutsourcing) {
          resultMessage += "‚úÖ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
        }
      } else {
        resultMessage += `‚ö†Ô∏è –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏: ${exportResult}\n`;
      }
    } else {
      resultMessage += "‚è≠Ô∏è –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏: –ø—Ä–æ–ø—É—â–µ–Ω–æ\n";
    }
    
    resultBox.style.color = '#059669';
    resultBox.textContent = resultMessage + "\nüéâ –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!";
    
    setTimeout(closeUpdateAllModal, 5000);
    
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
async function submitUpdateAll() {
  // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  selectAllUpdates();
  await submitSelectiveUpdate();
}



async function runCustomReport() {
  withLoading("reportBtn", async () => {
    const start = document.getElementById("unifiedStart").value;
const end = document.getElementById("unifiedEnd").value;

    if (!start || !end) {
      alert("‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?type=weeklyReport&start=${start}&end=${end}`);
      const text = await res.text();

      alert(text || "‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω");
    } catch (err) {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–∞: " + err.message);
    }
  });
}

async function analyzePackers() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —É–ø–∞–∫–æ–≤—â–∏–∫–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=packerAnalytics&start=${start}&end=${end}`);
    const json = await res.json();

    if (!json.ok) {
      container.innerHTML = "<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>";
      return;
    }

    const { list, best, totalNormsMet, totalNormsTotal, totalNormsPercent } = json;

    const rows = list.map(row => {
      let style = "";
      if (row.name === best.name) style = "background:#fef9c3;";          // üü® –ª—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
      if (row.name === best.bestEffName) style = "background:#d1fae5;";   // üü© –ª—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      if (row.name === best.worstEffName) style = "background:#fee2e2;"; // üü• —Ö—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

      // –î–ª—è –Ω–æ—Ä–º—ã
      const met = Number(row.normsMet);
      const total = Number(row.normsTotal);
      const percent = total > 0 ? Math.round((met / total) * 100) : 0;
      let normIcon = "‚ö†Ô∏è";
      if (total === 0) normIcon = "‚Äî";
      else if (percent >= 85) normIcon = "‚úÖ";
      else if (percent > 0) normIcon = "‚ö†Ô∏è";

      return `
        <tr style="${style}">
          <td>${row.name}</td>
          <td>${row.qty}</td>
          <td>${row.efficiency}%</td>
          <td>${row.wage.toLocaleString("ru-RU")} ‚ÇΩ</td>
          <td>${met}/${total} (${percent}%) ${normIcon}</td>
        </tr>
      `;
    }).join("");

    const table = `
      <h3>üìä –ê–Ω–∞–ª–∏–∑ —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤</h3>
      <button class="danger" onclick="clearReports()" style="margin-bottom: 12px;">‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç</button>
      <div class="table-scroll">
    <table border="1" cellpadding="6" style="border-collapse: collapse; width: 100%;">
        <thead style="background:#f3f4f6;">
          <tr>
            <th>–£–ø–∞–∫–æ–≤—â–∏–∫</th>
            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            <th>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th>–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th>–ù–æ—Ä–º—ã</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <br/>
      <p>
        ü•á <strong>–õ—É—á—à–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É:</strong> ${best.name} ‚Äî ${best.qty} —à—Ç.<br/>
        üíØ <strong>–õ—É—á—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.bestEffName} ‚Äî ${best.bestEffValue}%<br/>
        üîª <strong>–•—É–¥—à–∏–π –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:</strong> ${best.worstEffName} ‚Äî ${best.worstEffValue}%
      </p>
      <div style="margin-top:16px; padding:10px; background:#f3f4f6; border-radius:8px; font-weight:500;">
        üìä <b>–ò—Ç–æ–≥–æ –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –Ω–æ—Ä–º –∑–∞ —Å–º–µ–Ω—É:</b>
        <br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%)
      </div>
    `;

    container.innerHTML = table;

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞: ${err.message}</p>`;
  }
}


// üëá –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á—ë—Ç–æ–≤
function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}



async function withLoading(buttonId, asyncCallback) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
  setButtonLoading(btn, true);
  const originalText = btn.textContent;

  try {
    await asyncCallback();
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    setButtonSuccess(btn, 1500);
  } catch (err) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    btn.classList.add('danger');
    btn.textContent = '‚ùå –û—à–∏–±–∫–∞!';
    setTimeout(() => {
      btn.classList.remove('danger');
      btn.textContent = originalText;
      setButtonLoading(btn, false);
    }, 2000);
    console.error("–û—à–∏–±–∫–∞:", err);
    throw err;
  } finally {
    setTimeout(() => {
      setButtonLoading(btn, false);
    }, 1500);
  }
}

async function loadAllDictionariesInBackground() {
      try {
        await Promise.all([
          loadVolumes(),
          loadOperations(),
          loadSetNumbers(),
          loadTodayRecords(),
          loadOperationFilter(),
          loadRatesTable(),
          loadPackingModels()
        ]);


        document.getElementById("operationFilter").addEventListener("change", loadStats);
      } catch (err) {
        console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:", err.message);
      }
    }

function toggleReport(id, contentHtml) {
  const container = document.getElementById("reportContainer");
  const existing = container.querySelector(`.report[data-id='${id}']`);

  if (existing) {
    existing.remove(); // üíØ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –æ—Ç—á—ë—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
  } else {
    const wrapper = document.createElement("div");
    wrapper.classList.add("report");
    wrapper.dataset.id = id;
    wrapper.innerHTML = contentHtml;
    container.appendChild(wrapper);
  }
}

function clearReports() {
  const container = document.getElementById("reportContainer");
  container.innerHTML = "";
  isShiftStatsLoaded = false;
}

async function loadShiftStats() {
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —Å–º–µ–Ω–∞–º...</p>";

  try {
    const res = await fetch(`${scriptURL}?type=shiftStats&start=${start}&end=${end}`);
    const data = await res.json();

    if (!data || !data.data || !Array.isArray(data.data) || !data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    data.data.forEach(shiftBlock => {
  const shiftTitle = document.createElement("div");
  shiftTitle.innerHTML = `
    üïê <strong>–°–º–µ–Ω–∞:</strong> ${shiftBlock.shift}
    <br>üì¶ <strong>–ü–µ—Ä–µ—É–ø–∞–∫–æ–≤–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É:</strong> ${shiftBlock.total?.totalQty ?? 0} —à—Ç.
    <br>üë®‚Äçüîß <strong>–®—Ç–∞—Ç:</strong> ${shiftBlock.staff?.totalQty ?? 0} —à—Ç.
    <br>üìÑ <strong>–ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥:</strong> ${shiftBlock.outsource?.totalQty ?? 0} —à—Ç.
  `;
  shiftTitle.style.marginTop = "16px";
  container.appendChild(shiftTitle);

      // === –í–ê–ñ–ù–û: —Å–æ–∑–¥–∞—ë–º table ===
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.marginTop = "10px";

      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr style="background:#f3f4f6;">
          <th style="padding:6px; border:1px solid #ccc;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
          <th style="padding:6px; border:1px solid #ccc;">–ö–æ–ª-–≤–æ</th>
          <th style="padding:6px; border:1px solid #ccc; width:80px; max-width:80px;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
          <th style="padding:6px; border:1px solid #ccc;">–ù–æ—Ä–º—ã</th>
        </tr>
      `;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      const staff = shiftBlock?.staff?.employees || [];
      const outsource = shiftBlock?.outsource?.employees || [];

      if (staff.length) {
        const staffTitleRow = document.createElement("tr");
        staffTitleRow.innerHTML = `
          <td colspan="3" style="padding:6px; font-weight:bold; color:#1f2937;">
            üë®‚Äçüîß –®—Ç–∞—Ç (—Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.staff.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(staffTitleRow);

        staff.forEach(emp => {
          const tr = document.createElement("tr");
          
          // –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ—Ä–º–∞—Ö
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          

          
          // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ—Ä–º
          let normIcon = "‚Äî";
          if (normsTotal === 0) normIcon = "‚Äî";
          else if (normsPercent >= 85) normIcon = "‚úÖ";
          else if (normsPercent >= 60) normIcon = "‚ö†Ô∏è";
          else if (normsPercent > 0) normIcon = "‚ùå";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc; width:80px; max-width:80px; text-align:center;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      if (outsource.length) {
        const outTitleRow = document.createElement("tr");
        outTitleRow.innerHTML = `
          <td colspan="3" style="padding:6px; font-weight:bold; color:#6b21a8;">
            üìÑ –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ (—Å—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${shiftBlock.outsource.averageEfficiency}%)
          </td>
        `;
        tbody.appendChild(outTitleRow);

        outsource.forEach(emp => {
          const tr = document.createElement("tr");
          
          // –†–∞—Å—á–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ—Ä–º–∞—Ö
          const normsMet = emp.opsMet || 0;
          const normsTotal = emp.opsTotal || 0;
          const normsPercent = normsTotal > 0 ? Math.round((normsMet / normsTotal) * 100) : 0;
          

          
          // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –Ω–æ—Ä–º
          let normIcon = "‚Äî";
          if (normsTotal === 0) normIcon = "‚Äî";
          else if (normsPercent >= 85) normIcon = "‚úÖ";
          else if (normsPercent >= 60) normIcon = "‚ö†Ô∏è";
          else if (normsPercent > 0) normIcon = "‚ùå";
          
          tr.innerHTML = `
            <td style="padding:6px; border:1px solid #ccc;">${emp.name}</td>
            <td style="padding:6px; border:1px solid #ccc;">${emp.quantity}</td>
            <td style="padding:6px; border:1px solid #ccc; width:80px; max-width:80px; text-align:center;">${emp.efficiency}%</td>
            <td style="padding:6px; border:1px solid #ccc;">${normsMet}/${normsTotal} (${normsPercent}%) ${normIcon}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);

      // === –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ scrollDiv ===
      const scrollDiv = document.createElement("div");
      scrollDiv.className = "table-scroll";
      scrollDiv.appendChild(table);
      container.appendChild(scrollDiv);

      // === –ë–ª–æ–∫ –æ–±—â–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–æ—Ä–º (–ø–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω–µ)
      const staffEff = shiftBlock?.staff?.averageEfficiency;
      const outsourceEff = shiftBlock?.outsource?.averageEfficiency;
      const overallEff = shiftBlock?.total?.overall;
      
      // –ü–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö –Ω–æ—Ä–º –ø–æ —Å–º–µ–Ω–µ
      const allEmployees = [...(shiftBlock?.staff?.employees || []), ...(shiftBlock?.outsource?.employees || [])];
      const totalNormsMet = allEmployees.reduce((sum, emp) => sum + (emp.opsMet || 0), 0);
      const totalNormsTotal = allEmployees.reduce((sum, emp) => sum + (emp.opsTotal || 0), 0);
      const totalNormsPercent = totalNormsTotal > 0 ? Math.round((totalNormsMet / totalNormsTotal) * 100) : 0;
      
      // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –æ–±—â–∏—Ö –Ω–æ—Ä–º
      let totalNormIcon = "‚Äî";
      if (totalNormsTotal === 0) totalNormIcon = "‚Äî";
      else if (totalNormsPercent >= 85) totalNormIcon = "‚úÖ";
      else if (totalNormsPercent >= 60) totalNormIcon = "‚ö†Ô∏è";
      else if (totalNormsPercent > 0) totalNormIcon = "‚ùå";
      
      // –î–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "‚Äî" –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
      function effVal(val) {
        return (val === undefined || val === null) ? "‚Äî" : val + "%";
      }
      const footer = document.createElement("div");
      footer.style.marginTop = "12px";
      footer.style.padding = "12px";
      footer.style.background = "#ecfdf5";
      footer.style.borderRadius = "8px";
      footer.style.fontWeight = "500";
      footer.innerHTML = `
        üìä <b>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ —Å–º–µ–Ω—É:</b><br>
        üë®‚Äçüîß –®—Ç–∞—Ç ‚Äî ${effVal(staffEff)} |
        ü§ù –ê—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ ‚Äî ${effVal(outsourceEff)} |
        üì¶ –û–±—â–∞—è ‚Äî ${effVal(overallEff)}<br><br>
        üìã <b>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º –∑–∞ —Å–º–µ–Ω—É:</b><br>
        ${totalNormsMet}/${totalNormsTotal} (${totalNormsPercent}%) ${totalNormIcon}
      `;
      container.appendChild(footer);
    });

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
  }
}

async function loadSeniorsReport() {
  clearReports(); // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç—á–µ—Ç—ã
  
  const start = document.getElementById("unifiedStart").value;
  const end = document.getElementById("unifiedEnd").value;
  const container = document.getElementById("reportContainer");

  if (!start || !end) {
    container.innerHTML = "<p style='color:red;'>‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã</p>";
    return;
  }

  container.innerHTML = "<p>‚åõ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–∞ –ø–æ —Å—Ç–∞—Ä—à–∏–º —Å–º–µ–Ω–∞–º...</p>";

  try {
    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å:', `${scriptURL}?type=seniorsReport&start=${start}&end=${end}`);
    
    const res = await fetch(`${scriptURL}?type=seniorsReport&start=${start}&end=${end}`);
    console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', res.status);
    
    if (!res.ok) {
      container.innerHTML = `<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ HTTP: ${res.status} ${res.statusText}</p>`;
      return;
    }
    
    const data = await res.json();
    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data); // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

    if (!data) {
      container.innerHTML = "<p style='color:red;'>‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ</p>";
      return;
    }

    if (data.status !== 'success') {
      container.innerHTML = `<p style='color:red;'>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
      return;
    }

    if (!data.data || !Array.isArray(data.data)) {
      container.innerHTML = "<p style='color:red;'>‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞</p>";
      return;
    }

    if (!data.data.length) {
      container.innerHTML = "<p style='text-align:center;'>üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç–∞—Ä—à–∏–º —Å–º–µ–Ω–∞–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</p>";
      return;
    }

    container.innerHTML = "";

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "‚ùå –ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á—ë—Ç";
    closeBtn.className = "danger";
    closeBtn.style.marginBottom = "12px";
    closeBtn.onclick = () => (container.innerHTML = "");
    container.appendChild(closeBtn);

    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞
    const reportTitle = document.createElement("div");
    reportTitle.innerHTML = `
      <h3 style="margin-top: 0; color: #8b5cf6;">üë®‚Äçüíº –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</h3>
      <p style="color: #6b7280; margin-bottom: 16px;">–ü–µ—Ä–∏–æ–¥: ${start} ‚Äî ${end}</p>
    `;
    container.appendChild(reportTitle);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.style.marginTop = "10px";

    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr style="background:#f3f4f6;">
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–î–∞—Ç–∞</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–°–º–µ–Ω–∞</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:left;">–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:center;">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã</th>
        <th style="padding:8px; border:1px solid #d1d5db; text-align:right;">–ó–∞—Ä–ø–ª–∞—Ç–∞</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–º–µ–Ω–∞–º
    const shiftsData = {};
    data.data.forEach(item => {
      const shiftKey = item.shift;
      if (!shiftsData[shiftKey]) {
        shiftsData[shiftKey] = [];
      }
      shiftsData[shiftKey].push(item);
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–º–µ–Ω—ã
    const sortedShifts = Object.keys(shiftsData).sort();

    sortedShifts.forEach(shift => {
      const shiftItems = shiftsData[shift];
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–º–µ–Ω—ã
      const shiftHeader = document.createElement("tr");
      shiftHeader.innerHTML = `
        <td colspan="6" style="padding:8px; font-weight:bold; color:#8b5cf6; background:#f8f7ff; border:1px solid #d1d5db;">
          üïê ${shift}
        </td>
      `;
      tbody.appendChild(shiftHeader);

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–µ
      shiftItems.sort((a, b) => new Date(a.date.split('.').reverse().join('-')) - new Date(b.date.split('.').reverse().join('-')));

      shiftItems.forEach(item => {
        const tr = document.createElement("tr");
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        let rowStyle = "";
        if (item.efficiency >= 100) {
          rowStyle = "background:#ecfdf5;"; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤—ã—Å–æ–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        } else if (item.efficiency >= 80) {
          rowStyle = "background:#fef3c7;"; // –ñ–µ–ª—Ç—ã–π –¥–ª—è —Å—Ä–µ–¥–Ω–µ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        } else {
          rowStyle = "background:#fef2f2;"; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –Ω–∏–∑–∫–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        }

        tr.innerHTML = `
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.date}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.shift}</td>
          <td style="padding:8px; border:1px solid #d1d5db; ${rowStyle}">${item.name}</td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.efficiency >= 100 ? '#059669' : item.efficiency >= 80 ? '#d97706' : '#dc2626'}">
              ${item.efficiency}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:center; ${rowStyle}">
            <span style="font-weight:bold; color:${item.norm >= 80 ? '#059669' : '#dc2626'}">
              ${item.norm}%
            </span>
          </td>
          <td style="padding:8px; border:1px solid #d1d5db; text-align:right; ${rowStyle}">
            <strong>${item.salary.toLocaleString('ru-RU')} ‚ÇΩ</strong>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });

    table.appendChild(tbody);

    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ scrollDiv
    const scrollDiv = document.createElement("div");
    scrollDiv.className = "table-scroll";
    scrollDiv.appendChild(table);
    container.appendChild(scrollDiv);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–∫—É
    const totalSalary = data.data.reduce((sum, item) => sum + (item.salary || 0), 0);
    const avgEfficiency = data.data.reduce((sum, item) => sum + (item.efficiency || 0), 0) / data.data.length;
    const avgNorm = data.data.reduce((sum, item) => sum + (item.norm || 0), 0) / data.data.length;

    const summary = document.createElement("div");
    summary.style.marginTop = "16px";
    summary.style.padding = "16px";
    summary.style.background = "#f8f7ff";
    summary.style.borderRadius = "8px";
    summary.style.fontWeight = "500";
    summary.innerHTML = `
      üìä <b>–°–≤–æ–¥–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É:</b><br>
      üë®‚Äçüíº <strong>–í—Å–µ–≥–æ —Å–º–µ–Ω:</strong> ${data.data.length} |
      üí∞ <strong>–û–±—â–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞:</strong> ${totalSalary.toLocaleString('ru-RU')} ‚ÇΩ |
      üìà <strong>–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</strong> ${Math.round(avgEfficiency)}% |
      ‚úÖ <strong>–°—Ä–µ–¥–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–æ—Ä–º—ã:</strong> ${Math.round(avgNorm)}%
    `;
    container.appendChild(summary);

  } catch (err) {
    container.innerHTML = `<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</p>`;
  }
}

// üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
window.addEventListener('offline', () => {
  alert('üì° –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
});
window.addEventListener('online', () => {
  alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
});
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', reg.scope))
        .catch(err => console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
    });
  }

// ‚è± –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener("DOMContentLoaded", () => {
  const loginInput = document.getElementById("login");
  if (loginInput) loginInput.focus();
});

// üßº –°–±—Ä–æ—Å –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
["login", "password"].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener("input", () => {
      const error = document.getElementById("loginError");
      if (error) error.textContent = "";
    });
  }
});

// ‚èé –í—Ö–æ–¥ –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
document.getElementById("password").addEventListener("keydown", e => {
  if (e.key === "Enter") {
    handleLogin();
  }
});

function openSalaryExportModal() {
  // –û—á–∏—Å—Ç–∫–∞
  document.getElementById("salaryExportResult").textContent = "";
  document.getElementById("salaryExportModal").style.display = "flex";
  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("salaryExportStart").value = today;
  document.getElementById("salaryExportEnd").value = today;
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω
  loadSalaryExportEmployees();
  loadSalaryExportSeniors();
}

function closeSalaryExportModal() {
  document.getElementById("salaryExportModal").style.display = "none";
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
function toggleEmployeeExportSelector() {
    const type = document.querySelector('input[name="exportType"]:checked').value;
    const packersSelector = document.getElementById("packersExportSelector");
    const seniorsSelector = document.getElementById("seniorsExportSelector");
    
    if (type === 'seniors') {
        packersSelector.style.display = 'none';
        seniorsSelector.style.display = 'block';
    } else {
        packersSelector.style.display = 'block';
        seniorsSelector.style.display = 'none';
    }
}

async function loadSalaryExportEmployees() {
  try {
    const res = await fetch(`${scriptURL}?type=employees`);
    const data = await res.json();

    const names = Array.from(new Set((data.employees || []))).sort();
    const select = document.getElementById("salaryExportEmployee");

    select.innerHTML = `<option value="">-- –í—Å–µ --</option>`;
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤!";
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:", err);
  }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞
async function loadSalaryExportSeniors() {
  try {
    const res = await fetch(`${scriptURL}?type=getSeniorsList`);
    const data = await res.json();

    const seniors = Array.from(new Set((data.seniors || []))).sort();
    const select = document.getElementById("salaryExportSenior");

    select.innerHTML = `<option value="">-- –í—Å–µ --</option>`;
    seniors.forEach(senior => {
      const opt = document.createElement("option");
      opt.value = senior;
      opt.textContent = senior;
      select.appendChild(opt);
    });
  } catch (err) {
    document.getElementById("salaryExportResult").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω!";
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω:", err);
  }
}

async function submitSalaryExport() {
  const btn = document.getElementById("submitSalaryExportBtn");
  const resultBox = document.getElementById("salaryExportResult");

  // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";
  resultBox.textContent = "";

  const start = document.getElementById("salaryExportStart").value;
  const end = document.getElementById("salaryExportEnd").value;
  const exportType = document.querySelector('input[name="exportType"]:checked').value;

  if (!start || !end) {
    resultBox.textContent = "‚ùó –£–∫–∞–∂–∏—Ç–µ –æ–±–µ –¥–∞—Ç—ã!";
    btn.disabled = false;
    btn.textContent = originalText;
    return;
  }

  let scriptUrl = scriptURL;
  let fetchOptions = {};

  if (exportType === 'seniors') {
    // –î–ª—è —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ exportSeniorsForAccounting
    const senior = document.getElementById("salaryExportSenior").value;
    const params = new URLSearchParams({
        type: "exportSeniorsForAccounting",
        start,
        end
    });
    if (senior) {
        params.append("seniors", senior);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  } else { 
    // –î–ª—è —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ exportForAccounting
    const employee = document.getElementById("salaryExportEmployee").value;
    const params = new URLSearchParams({
        type: "exportForAccounting",
        start,
        end
    });
    if (employee) {
        params.append("employees", employee);
    }
    scriptUrl = `${scriptURL}?${params.toString()}`;
  }
  
  try {
    const res = await fetch(scriptUrl);
    const text = await res.text();
    
    resultBox.style.color = text.includes("‚úÖ") ? '#059669' : '#dc2626';
    resultBox.textContent = text;
    
    if (text.includes("‚úÖ")) {
        setTimeout(closeSalaryExportModal, 3000);
    }
  } catch (err) {
    console.error(err);
    resultBox.style.color = '#dc2626';
    resultBox.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞";
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function checkUserStructure() {
  const btn = document.getElementById("checkStructureBtn");
  const container = document.getElementById("reportContainer");
  
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...";
  
  try {
    const res = await fetch(`${scriptURL}?type=checkUserStructure`);
    const data = await res.json();
    
    if (data.error) {
      container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
        <h3>‚ùå –û—à–∏–±–∫–∞</h3>
        <p>${data.error}</p>
      </div>`;
      return;
    }
    
    const structure = data.structure;
    let html = `
      <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; margin-top: 16px;">
        <h3>üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
        <p><strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫:</strong> ${structure.totalRows}</p>
        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫:</strong> ${structure.columnCount}</p>
        
        <h4>üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏:</h4>
        <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0;">
          ${structure.headers.map((header, index) => `<span style="display: inline-block; margin-right: 16px;"><strong>${index}:</strong> ${header || '(–ø—É—Å—Ç–æ)'}</span>`).join('')}
        </div>
        
        <h4>üìä –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏):</h4>
        ${structure.sampleData.map((row, index) => `
          <div style="background: white; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace;">
            <strong>–°—Ç—Ä–æ–∫–∞ ${index + 1}:</strong> ${row.map((cell, cellIndex) => `<span style="margin-right: 16px;"><strong>${cellIndex}:</strong> ${cell || '(–ø—É—Å—Ç–æ)'}</span>`).join('')}
          </div>
        `).join('')}
        
        <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 4px;">
          <h4>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</h4>
          <p>–û–∫–ª–∞–¥ –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º <strong>4</strong> (5-—è –∫–æ–ª–æ–Ω–∫–∞).</p>
          <p>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ —Å –∏–Ω–¥–µ–∫—Å–æ–º <strong>0</strong> (1-—è –∫–æ–ª–æ–Ω–∫–∞).</p>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:", error);
    container.innerHTML = `<div style="color: red; padding: 16px; background: #fef2f2; border-radius: 8px;">
      <h3>‚ùå –û—à–∏–±–∫–∞</h3>
      <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞: ${error.message}</p>
    </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

</script>
<div id="editModal" style="display:none; position:fixed; top:10%; left:0; right:0; margin:auto; max-width:500px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.3); z-index:1000;">
  <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</h3>
  <form id="editForm">
  <input type="hidden" name="rowIndex" />
  <input type="hidden" name="employeeName" />
  <input type="hidden" name="orderNumber" />
  <input type="hidden" name="shiftType" />
  <input type="hidden" name="employeeStatus" />
  <input type="hidden" name="duration" />

  <label>–û–ø–µ—Ä–∞—Ü–∏—è:
    <select name="operationType" id="editOperation" required></select>
  </label>

  <label id="editVolumeLabel">–û–±—ä—ë–º:
    <select name="volume" id="editVolumeSelect"></select>
  </label>

  <div id="editSetNumberField" style="display:none;">
    <label>–ê—Ä—Ç–∏–∫—É–ª –Ω–∞–±–æ—Ä–∞:
      <select name="setNumber" id="editSetNumberSelect"></select>
    </label>
  </div>

  <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:<input name="quantity" type="number" required /></label>
  <label>–ù–∞—á–∞–ª–æ:<input name="startTime" type="time" required /></label>
  <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ:<input name="endTime" type="time" required /></label>

  <button type="button" onclick="submitEditForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button type="button" onclick="closeEditModal()" class="danger">‚ùå –û—Ç–º–µ–Ω–∞</button>
</form>
</div>
<div id="salaryExportModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:420px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">üíµ –í—ã–≥—Ä—É–∑–∫–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã</h3>
    <label>–ü–µ—Ä–∏–æ–¥ —Å: <input type="date" id="salaryExportStart" /></label><br>
    <label>–ø–æ: <input type="date" id="salaryExportEnd" /></label><br>
    
    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –≤—ã–≥—Ä—É–∑–∫–∏ -->
    <label style="margin-top:16px; display:block;">–¢–∏–ø –≤—ã–≥—Ä—É–∑–∫–∏:</label>
    <div id="exportTypeSelector" style="display: flex; gap: 10px; margin-top: 8px;">
        <style>
            #exportTypeSelector label { display: block; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; cursor: pointer; flex-grow: 1; text-align: center; transition: all 0.2s ease-in-out; }
            #exportTypeSelector input[type="radio"] { display: none; }
            #exportTypeSelector input[type="radio"]:checked + label { background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        </style>
        <input type="radio" id="exportTypePackers" name="exportType" value="packers" checked onchange="toggleEmployeeExportSelector()">
        <label for="exportTypePackers">üì¶ –£–ø–∞–∫–æ–≤—â–∏–∫–∏</label>
        <input type="radio" id="exportTypeSeniors" name="exportType" value="seniors" onchange="toggleEmployeeExportSelector()">
        <label for="exportTypeSeniors">üë®‚Äçüíº –°—Ç–∞—Ä—à–∏–µ —Å–º–µ–Ω</label>
    </div>

    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —É–ø–∞–∫–æ–≤—â–∏–∫–æ–≤ -->
    <div id="packersExportSelector" style="margin-top:16px;">
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:
          <select id="salaryExportEmployee" style="width:100%;margin-top:7px;">
            <option value="">-- –í—Å–µ --</option>
          </select>
        </label>
    </div>

    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω -->
    <div id="seniorsExportSelector" style="margin-top:16px; display:none;">
        <label>–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã:
          <select id="salaryExportSenior" style="width:100%;margin-top:7px;">
            <option value="">-- –í—Å–µ --</option>
          </select>
        </label>
    </div>

    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSalaryExport()" id="submitSalaryExportBtn" style="flex:1;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="closeSalaryExportModal()" style="flex:1;background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="salaryExportResult" style="margin-top:16px; font-weight:500; text-align:center;"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö -->
<div id="updateAllModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:white; max-width:500px; margin:60px auto; border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.15); padding:28px; position:relative;">
    <h3 style="margin-top:0;">üîÑ –í—ã–±–æ—Ä–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h3>
    <p style="color:#6b7280; font-size:14px; margin-bottom:20px;">
      –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è, —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—è—é—Ç—Å—è/–¥–æ–ø–æ–ª–Ω—è—é—Ç—Å—è.
    </p>
    
    <label>–ü–µ—Ä–∏–æ–¥ —Å: <input type="date" id="updateAllStart" /></label><br>
    <label>–ø–æ: <input type="date" id="updateAllEnd" /></label><br>
    
    <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
    <div style="margin-top:20px; border:1px solid #e5e7eb; border-radius:8px; padding:16px; background:#f9fafb;">
      <h4 style="margin:0 0 12px 0; font-size:16px; color:#374151;">–ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å:</h4>
      
      <div style="display:flex; flex-direction:column; gap:12px;">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateSeniorsSalary" checked style="width:16px; height:16px;">
          <div>
            <strong>üë®‚Äçüíº –ó–∞—Ä–ø–ª–∞—Ç—ã —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω</strong>
            <div style="font-size:12px; color:#6b7280;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç —Å—Ç–∞—Ä—à–∏—Ö —Å–º–µ–Ω –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateStaffIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>üìä –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —à—Ç–∞—Ç–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</strong>
            <div style="font-size:12px; color:#6b7280;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–æ—Ä–º —à—Ç–∞—Ç–∞</div>
          </div>
        </label>
        
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
          <input type="checkbox" id="updateOutsourcingIndicators" checked style="width:16px; height:16px;">
          <div>
            <strong>üè¢ –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥–∞</strong>
            <div style="font-size:12px; color:#6b7280;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –ø–æ–¥—Ä—è–¥—á–∏–∫–æ–≤</div>
          </div>
        </label>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ -->
      <div style="margin-top:16px; display:flex; gap:8px; border-top:1px solid #e5e7eb; padding-top:12px;">
        <button type="button" onclick="selectAllUpdates()" style="flex:1; background:#e5e7eb; color:#374151; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">‚úÖ –í—Å–µ</button>
        <button type="button" onclick="selectNoneUpdates()" style="flex:1; background:#e5e7eb; color:#374151; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">‚ùå –ù–∏—á–µ–≥–æ</button>
        <button type="button" onclick="selectOnlySeniors()" style="flex:1; background:#e5e7eb; color:#374151; border:none; padding:6px 12px; border-radius:4px; font-size:12px; cursor:pointer;">üë®‚Äçüíº –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ä—à–∏–µ</button>
      </div>
    </div>
    
    <div style="margin-top:18px;display:flex;gap:10px;">
      <button onclick="submitSelectiveUpdate()" id="submitUpdateAllBtn" style="flex:1; background:#8b5cf6;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
      <button onclick="closeUpdateAllModal()" style="flex:1;background:#ef4444;">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="updateAllResult" style="margin-top:16px; font-weight:500; text-align:center; white-space:pre-line;"></div>
  </div>
</div>

<script>
  window.addEventListener("load", () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–π –∫–Ω–æ–ø–æ–∫
    initButtonAnimations();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –≤–∞–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setTimeout(() => {
      document.querySelectorAll('.container').forEach((container, index) => {
        container.classList.add('fade-in');
        container.style.animationDelay = `${index * 0.1}s`;
      });
    }, 100);
    
    setTimeout(() => {
      const screen = document.getElementById("loadingScreen");
      if (screen) {
        screen.style.opacity = "0";
        screen.style.transition = "opacity 0.5s ease";
        setTimeout(() => screen.remove(), 500); // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      }
    }, 1000); // –ó–ê–î–ï–†–ñ–ö–ê 1 —Å–µ–∫—É–Ω–¥–∞
  });

  // –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
  function switchTab(tabName) {
    // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    if (currentUserRole === "admin" && tabName !== "admin") {
      return; // –ù–µ –ø–æ–∑–≤–æ–ª—è–µ–º –∞–¥–º–∏–Ω—É –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏
    }
    
    // üîê –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –µ—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    if (currentUserRole !== "admin" && tabName !== "profile" && !requireProfile()) return;

    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    const containers = [
      document.getElementById("profileContainer"),
      document.getElementById("appContainer"),
      document.getElementById("statsContainer"),
      document.getElementById("adminContainer"),
      document.getElementById("mySalaryContainer"),
      document.getElementById("ratesContainer")
    ];

    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const currentContainer = containers.find(container => 
      container && container.style.display !== "none"
    );

    // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    let targetContainer;
    switch (tabName) {
      case "profile":
        targetContainer = document.getElementById("profileContainer");
        break;
      case "app":
        targetContainer = document.getElementById("appContainer");
        break;
      case "stats":
        targetContainer = document.getElementById("statsContainer");
        break;
      case "rates":
        targetContainer = document.getElementById("ratesContainer");
        break;
      case "mySalary":
        targetContainer = document.getElementById("mySalaryContainer");
        break;
      case "admin":
        targetContainer = document.getElementById("adminContainer");
        break;
    }

    if (!targetContainer || targetContainer === currentContainer) return;

    // –ü–õ–ê–í–ù–´–ô –ü–ï–†–ï–•–û–î –ë–ï–ó –ü–û–î–ü–†–´–ì–ò–í–ê–ù–ò–Ø
    // 1. –§–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É body
    const currentHeight = document.body.scrollHeight;
    document.body.style.minHeight = currentHeight + 'px';

    // 2. –ü–ª–∞–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (currentContainer) {
      currentContainer.style.opacity = '0';
      currentContainer.style.transform = 'translateY(-10px)';
      currentContainer.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
    }

    // 3. –ß–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    setTimeout(() => {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      containers.forEach(container => {
        if (container) {
          container.style.display = "none";
          container.style.opacity = '';
          container.style.transform = '';
          container.style.transition = '';
        }
      });

      // –£–¥–∞–ª—è–µ–º fullscreen –æ—Ç appContainer, –µ—Å–ª–∏ –±—ã–ª —Ä–∞–Ω–µ–µ
      document.getElementById("appContainer").classList.remove("fullscreen");

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      if (targetContainer) {
        targetContainer.style.display = "block";
        targetContainer.style.opacity = '0';
        targetContainer.style.transform = 'translateY(10px)';
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        targetContainer.offsetHeight;
        
        // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
        targetContainer.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        targetContainer.style.opacity = '1';
        targetContainer.style.transform = 'translateY(0)';
        
        // –£–±–∏—Ä–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
          document.body.style.minHeight = '';
          targetContainer.style.transition = '';
        }, 250);
        
        // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        setTimeout(() => {
          targetContainer.querySelectorAll('.container, .stat-card').forEach((element, index) => {
            setTimeout(() => {
              animateIn(element);
            }, index * 30);
          });
        }, 100);
      }
    }, 150);

    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    document.querySelectorAll('.top-nav button').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const navButtons = {
      'profile': 0,
      'app': 1, 
      'stats': 2,
      'rates': 3,
      'mySalary': 4,
      'admin': 3
    };
    
    const buttonIndex = navButtons[tabName];
    if (buttonIndex !== undefined) {
      const navButton = document.querySelectorAll('.top-nav button')[buttonIndex];
      if (navButton) {
        navButton.classList.add('active');
      }
    }
  }

  // === –ú–û–ë–ò–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∂–µ—Å—Ç–æ–≤
  let startX = 0;
  let startY = 0;
  let currentX = 0;
  let currentY = 0;
  let isSwipping = false;
  let pullDistance = 0;
  const maxPullDistance = 80;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
  function initMobileFeatures() {
    if (isMobileDevice()) {
      document.body.addEventListener('touchstart', handleTouchStart, { passive: false });
      document.body.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.body.addEventListener('touchend', handleTouchEnd, { passive: false });
      
      // Haptic feedback –¥–ª—è –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('touchstart', () => {
          hapticFeedback();
          button.classList.add('haptic-feedback');
          setTimeout(() => button.classList.remove('haptic-feedback'), 200);
        });
      });
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Service Worker –¥–ª—è PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(console.log);
      }
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  function isMobileDevice() {
    return window.innerWidth <= 768 || 'ontouchstart' in window;
  }

  // Haptic feedback (–≤–∏–±—Ä–∞—Ü–∏—è)
  function hapticFeedback(intensity = 'light') {
    if (navigator.vibrate) {
      const patterns = {
        light: [10],
        medium: [20],
        heavy: [30]
      };
      navigator.vibrate(patterns[intensity] || patterns.light);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è
  function handleTouchStart(e) {
    if (e.touches.length === 1) {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      currentX = startX;
      currentY = startY;
      isSwipping = false;
      pullDistance = 0;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
  function handleTouchMove(e) {
    if (e.touches.length === 1) {
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
      
      const deltaX = currentX - startX;
      const deltaY = currentY - startY;
      
      // Pull-to-refresh
      if (window.scrollY === 0 && deltaY > 0 && Math.abs(deltaX) < 50) {
        e.preventDefault();
        pullDistance = Math.min(deltaY * 0.5, maxPullDistance);
        updatePullToRefresh();
      }
      
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å–≤–∞–π–ø—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 30) {
        if (!isSwipping) {
          isSwipping = true;
          showSwipeIndicator(deltaX > 0 ? 'right' : 'left');
        }
      }
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
  function handleTouchEnd(e) {
    const deltaX = currentX - startX;
    const deltaY = currentY - startY;
    
    // Pull-to-refresh
    if (pullDistance > 50) {
      triggerRefresh();
    } else {
      resetPullToRefresh();
    }
    
    // –°–≤–∞–π–ø –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    if (isSwipping && Math.abs(deltaX) > 100) {
      if (deltaX > 0) {
        // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –ø—Ä–µ–¥—ã–¥—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞
        navigateTab(-1);
      } else {
        // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - —Å–ª–µ–¥—É—é—â–∞—è –≤–∫–ª–∞–¥–∫–∞
        navigateTab(1);
      }
      hapticFeedback('medium');
    }
    
    hideSwipeIndicators();
    isSwipping = false;
    pullDistance = 0;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Pull-to-refresh
  function updatePullToRefresh() {
    const indicator = document.getElementById('pullToRefresh');
    if (indicator) {
      indicator.style.transform = `translateX(-50%) translateY(${pullDistance - 100}px)`;
      indicator.textContent = pullDistance > 50 ? '‚Üë –û—Ç–ø—É—Å—Ç–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '‚Üì –ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
      
      if (pullDistance > 50) {
        indicator.classList.add('active');
      } else {
        indicator.classList.remove('active');
      }
    }
  }

  // –°–±—Ä–æ—Å Pull-to-refresh
  function resetPullToRefresh() {
    const indicator = document.getElementById('pullToRefresh');
    if (indicator) {
      indicator.style.transform = 'translateX(-50%) translateY(-100%)';
      indicator.classList.remove('active');
      indicator.textContent = '‚Üì –ü–æ—Ç—è–Ω–∏—Ç–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
    }
  }

  // –¢—Ä–∏–≥–≥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  function triggerRefresh() {
    const indicator = document.getElementById('pullToRefresh');
    if (indicator) {
      indicator.textContent = 'üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      indicator.classList.add('active');
      
      // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤–∞–π–ø–∞
  function showSwipeIndicator(direction) {
    const indicator = document.getElementById(`swipe${direction === 'left' ? 'Left' : 'Right'}`);
    if (indicator) {
      indicator.classList.add('show');
    }
  }

  // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–≤–∞–π–ø–∞
  function hideSwipeIndicators() {
    document.getElementById('swipeLeft').classList.remove('show');
    document.getElementById('swipeRight').classList.remove('show');
  }

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
  function navigateTab(direction) {
    const tabs = ['profile', 'app', 'stats', 'rates', 'mySalary'];
    const currentTab = getCurrentTab();
    const currentIndex = tabs.indexOf(currentTab);
    
    if (currentIndex !== -1) {
      const newIndex = (currentIndex + direction + tabs.length) % tabs.length;
      switchTab(tabs[newIndex]);
    }
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
  function getCurrentTab() {
    const containers = ['profileContainer', 'appContainer', 'statsContainer', 'ratesContainer', 'mySalaryContainer'];
    for (const container of containers) {
      if (document.getElementById(container).style.display !== 'none') {
        return container.replace('Container', '');
      }
    }
    return 'profile';
  }

  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  function optimizePerformance() {
    // Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ—Å–∞–π–∑–∞
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        adjustForMobile();
      }, 250);
    });
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        optimizeScrollPerformance();
      }, 100);
    }, { passive: true });
  }

  // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–±–∏–ª—å–Ω—ã–µ
  function adjustForMobile() {
    if (isMobileDevice()) {
      document.body.classList.add('mobile');
      
      // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
      setupMobileKeyboard();
    } else {
      document.body.classList.remove('mobile');
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  function setupMobileKeyboard() {
    const inputs = document.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∏–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä
      if (input.type === 'text' && input.name && input.name.includes('phone')) {
        input.type = 'tel';
      }
      if (input.type === 'text' && input.name && input.name.includes('email')) {
        input.type = 'email';
      }
      
      // –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∏ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
      input.setAttribute('autocapitalize', 'sentences');
      input.setAttribute('spellcheck', 'true');
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ iOS
      input.addEventListener('focus', () => {
        if (window.innerWidth < 768) {
          window.scrollTo(0, input.offsetTop - 100);
        }
      });
    });
  }

  // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞
  function optimizeScrollPerformance() {
    const scrolled = window.scrollY;
    const rate = scrolled * -0.5;
    
    // –ü–∞—Ä–∞–ª–ª–∞–∫—Å —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen && !loadingScreen.hidden) {
      loadingScreen.style.transform = `translateY(${rate}px)`;
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  document.addEventListener('DOMContentLoaded', () => {
    initMobileFeatures();
    optimizePerformance();
    adjustForMobile();
  });

  // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞
  window.addEventListener('orientationchange', () => {
    setTimeout(adjustForMobile, 500);
  });

</script>
</body>
</html>
